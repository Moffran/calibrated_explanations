name: update-baseline

on:
  workflow_dispatch:
    inputs:
      reason:
        description: "Why update baseline?"
        required: false
      override_thresholds:
        description: "Also regenerate perf thresholds (yes/no)"
        required: false
        default: "no"

permissions:
  contents: write
  pull-requests: write

jobs:
  collect:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install . psutil

      - name: Generate new baseline & micro benchmarks
        id: gen
        run: |
          DATE_TAG=$(date -u +%Y%m%d)
          # API baseline collection not automated here; keep previous behavior minimal
          # Save micro benchmarks for perf guard
          python scripts/micro_bench_perf.py > benchmarks/micro_${DATE_TAG}.json
          echo "date_tag=$DATE_TAG" >> $GITHUB_OUTPUT

      - name: Micro baseline diff vs current committed baseline
        id: api_diff
        run: |
          OLD=$(ls benchmarks/micro_*.json | sort | head -n 1 || true)
          NEW=benchmarks/micro_${{ steps.gen.outputs.date_tag }}.json
          echo "Old micro baseline: $OLD" > perf_diff.txt
          echo "New micro baseline: $NEW" >> perf_diff.txt
          if [ -n "$OLD" ]; then python scripts/check_perf_micro.py "$OLD" "$NEW" benchmarks/perf_thresholds.json >> perf_diff.txt || true; else echo "No existing micro baseline found." >> perf_diff.txt; fi
          cat perf_diff.txt

      - name: Maybe regenerate thresholds
        if: ${{ github.event.inputs.override_thresholds == 'yes' }}
        run: |
          # Simple heuristic: keep existing structure; no automatic change implemented
          echo "Threshold regeneration not automated; adjust manually if needed." >> perf_diff.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: new-micro-baseline-${{ steps.gen.outputs.date_tag }}
          path: |
            benchmarks/micro_${{ steps.gen.outputs.date_tag }}.json
            perf_diff.txt

      - name: Create Pull Request with new baseline
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "chore: update micro performance baseline ${{ steps.gen.outputs.date_tag }}"
          title: "Update micro performance baseline ${{ steps.gen.outputs.date_tag }}"
          body: |
            Reason: ${{ github.event.inputs.reason || 'manual update' }}

            Includes:
            - benchmarks/micro_${{ steps.gen.outputs.date_tag }}.json

            Perf summary:
            ```
            $(cat perf_diff.txt)
            ```
          branch: chore/update-baseline-${{ steps.gen.outputs.date_tag }}
          base: main
          add-paths: |
            benchmarks/micro_${{ steps.gen.outputs.date_tag }}.json
            perf_diff.txt
          labels: performance, baseline-update
