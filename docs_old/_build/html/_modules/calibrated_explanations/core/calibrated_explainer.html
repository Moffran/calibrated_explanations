<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../genindex.html"><link rel="search" title="Search" href="../../../search.html">

    <!-- Generated with Sphinx 8.1.3 and Furo 2025.09.25 -->
        <title>calibrated_explanations.core.calibrated_explainer - calibrated_explanations v0.8.0</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?v=580074bf" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">calibrated_explanations v0.8.0</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
  
  <span class="sidebar-brand-text">calibrated_explanations v0.8.0</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  
</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for calibrated_explanations.core.calibrated_explainer</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Calibrated Explanations for Black-Box Predictions (calibrated-explanations).</span>

<span class="sd">The calibrated explanations explanation method is based on the paper</span>
<span class="sd">&quot;Calibrated Explanations: with Uncertainty Information and Counterfactuals&quot;</span>
<span class="sd">by Helena Löfström, Tuwe Löfström, Ulf Johansson and Cecilia Sönströd.</span>

<span class="sd">Calibrated explanations are a way to explain the predictions of a black-box learner</span>
<span class="sd">using Venn-Abers predictors (classification &amp; regression) or</span>
<span class="sd">conformal predictive systems (regression).</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># pylint: disable=unknown-option-value</span>
<span class="c1"># pylint: disable=invalid-name, line-too-long, too-many-lines, too-many-positional-arguments, too-many-public-methods</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">contextlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">tomllib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_tomllib</span>
<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>  <span class="c1"># pragma: no cover - fallback for &lt;3.11</span>
    <span class="k">try</span><span class="p">:</span>  <span class="c1"># pragma: no cover - optional dependency path</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">tomli</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_tomllib</span>  <span class="c1"># type: ignore[assignment]</span>
    <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>  <span class="c1"># pragma: no cover - tomllib unavailable</span>
        <span class="n">_tomllib</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore[assignment]</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">crepes</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConformalClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">crepes.extras</span><span class="w"> </span><span class="kn">import</span> <span class="n">hinge</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">confusion_matrix</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..plotting</span><span class="w"> </span><span class="kn">import</span> <span class="n">_plot_global</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.venn_abers</span><span class="w"> </span><span class="kn">import</span> <span class="n">VennAbers</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..explanations</span><span class="w"> </span><span class="kn">import</span> <span class="n">AlternativeExplanations</span><span class="p">,</span> <span class="n">CalibratedExplanations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..utils.discretizers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">BinaryEntropyDiscretizer</span><span class="p">,</span>
    <span class="n">BinaryRegressorDiscretizer</span><span class="p">,</span>
    <span class="n">EntropyDiscretizer</span><span class="p">,</span>
    <span class="n">RegressorDiscretizer</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..utils.helper</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">assert_threshold</span><span class="p">,</span>
    <span class="n">check_is_fitted</span><span class="p">,</span>
    <span class="n">concatenate_thresholds</span><span class="p">,</span>
    <span class="n">convert_targets_to_numeric</span><span class="p">,</span>
    <span class="n">immutable_array</span><span class="p">,</span>
    <span class="n">safe_import</span><span class="p">,</span>
    <span class="n">safe_mean</span><span class="p">,</span>
    <span class="n">safe_isinstance</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..api.params</span><span class="w"> </span><span class="kn">import</span> <span class="n">canonicalize_kwargs</span><span class="p">,</span> <span class="n">validate_param_combination</span><span class="p">,</span> <span class="n">warn_on_aliases</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..plugins</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ExplanationContext</span><span class="p">,</span>
    <span class="n">ExplanationRequest</span><span class="p">,</span>
    <span class="n">IntervalCalibratorContext</span><span class="p">,</span>
    <span class="n">validate_explanation_batch</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..plugins.builtins</span><span class="w"> </span><span class="kn">import</span> <span class="n">LegacyPredictBridge</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..plugins.registry</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">EXPLANATION_PROTOCOL_VERSION</span><span class="p">,</span>
    <span class="n">ensure_builtin_plugins</span><span class="p">,</span>
    <span class="n">find_explanation_descriptor</span><span class="p">,</span>
    <span class="n">find_explanation_plugin</span><span class="p">,</span>
    <span class="n">find_interval_descriptor</span><span class="p">,</span>
    <span class="n">find_interval_plugin</span><span class="p">,</span>
    <span class="n">find_interval_plugin_trusted</span><span class="p">,</span>
    <span class="n">is_identifier_denied</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..plugins.predict</span><span class="w"> </span><span class="kn">import</span> <span class="n">PredictBridge</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ValidationError</span><span class="p">,</span>
    <span class="n">DataShapeError</span><span class="p">,</span>
    <span class="n">ConfigurationError</span><span class="p">,</span>
    <span class="n">NotFittedError</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_read_pyproject_section</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a mapping from the requested ``pyproject.toml`` section.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">_tomllib</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">candidate</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;pyproject.toml&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">candidate</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">candidate</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>  <span class="c1"># type: ignore[arg-type]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">_tomllib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover - permissive fallback</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">cursor</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_split_csv</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Split a comma separated environment variable into a tuple.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">()</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_coerce_string_tuple</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Coerce a configuration value into a tuple of strings.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">value</span><span class="p">,)</span> <span class="k">if</span> <span class="n">value</span> <span class="k">else</span> <span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
        <span class="n">result</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">()</span>


<span class="n">_EXPLANATION_MODES</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;factual&quot;</span><span class="p">,</span> <span class="s2">&quot;alternative&quot;</span><span class="p">,</span> <span class="s2">&quot;fast&quot;</span><span class="p">)</span>

<span class="n">_DEFAULT_EXPLANATION_IDENTIFIERS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;factual&quot;</span><span class="p">:</span> <span class="s2">&quot;core.explanation.factual&quot;</span><span class="p">,</span>
    <span class="s2">&quot;alternative&quot;</span><span class="p">:</span> <span class="s2">&quot;core.explanation.alternative&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fast&quot;</span><span class="p">:</span> <span class="s2">&quot;core.explanation.fast&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_PredictBridgeMonitor</span><span class="p">(</span><span class="n">PredictBridge</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Runtime guard ensuring plugins use the calibrated predict bridge.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bridge</span><span class="p">:</span> <span class="n">PredictBridge</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bridge</span> <span class="o">=</span> <span class="n">bridge</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">bins</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;predict&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bridge</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_interval</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">bins</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;predict_interval&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bridge</span><span class="o">.</span><span class="n">predict_interval</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">bins</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;predict_proba&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bridge</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calls</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">used</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">)</span>


<div class="viewcode-block" id="CalibratedExplainer">
<a class="viewcode-back" href="../../../_autosummary/calibrated_explanations.core.CalibratedExplainer.html#calibrated_explanations.core.CalibratedExplainer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CalibratedExplainer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The :class:`.CalibratedExplainer` class is used for explaining machine learning learners with calibrated predictions.</span>

<span class="sd">    The calibrated explanations are based on the paper</span>
<span class="sd">    &quot;Calibrated Explanations for Black-Box Predictions&quot;</span>
<span class="sd">    by Helena Löfström, Tuwe Löfström, Ulf Johansson and Cecilia Sönströd.</span>

<span class="sd">    Calibrated explanations provides a way to explain the predictions of a black-box learner</span>
<span class="sd">    using Venn-Abers predictors (classification) or</span>
<span class="sd">    conformal predictive systems (regression).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># pylint: disable=too-many-instance-attributes, too-many-arguments, too-many-locals, too-many-branches, too-many-statements</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">learner</span><span class="p">,</span>
        <span class="n">x_cal</span><span class="p">,</span>
        <span class="n">y_cal</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;classification&quot;</span><span class="p">,</span>
        <span class="n">feature_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">categorical_features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">categorical_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">class_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">difficulty_estimator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the explainer with calibration data and metadata.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        learner : Any</span>
<span class="sd">            Predictive learner that must already expose ``fit``/``predict`` and,</span>
<span class="sd">            for classification, ``predict_proba``.</span>
<span class="sd">        x_cal : array-like of shape (n_calibration_samples, n_features)</span>
<span class="sd">            Calibration feature matrix used to fit interval calibrators.</span>
<span class="sd">        y_cal : array-like of shape (n_calibration_samples,)</span>
<span class="sd">            Calibration targets paired with ``x_cal``.</span>
<span class="sd">        mode : {&quot;classification&quot;, &quot;regression&quot;}, default=&quot;classification&quot;</span>
<span class="sd">            Operating mode controlling which calibrators/plugins are used.</span>
<span class="sd">        feature_names : Sequence[str] or None, optional</span>
<span class="sd">            Optional list of human-readable feature names.</span>
<span class="sd">        categorical_features : Sequence[int] or None, optional</span>
<span class="sd">            Indices describing which features should be treated as categorical.</span>
<span class="sd">        categorical_labels : Mapping[int, Mapping[int, str]] or None, optional</span>
<span class="sd">            Optional mapping translating categorical feature values to labels.</span>
<span class="sd">        class_labels : Mapping[int, str] or None, optional</span>
<span class="sd">            Optional mapping translating class indices to display labels.</span>
<span class="sd">        bins : array-like or None, optional</span>
<span class="sd">            Pre-computed Mondrian categories for fast explanations.</span>
<span class="sd">        difficulty_estimator : Any or None, optional</span>
<span class="sd">            Optional crepes ``DifficultyEstimator`` instance for regression tasks.</span>
<span class="sd">        **kwargs : Any</span>
<span class="sd">            Advanced configuration flags preserved for backward compatibility.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Minimal lifecycle logging is available at INFO level. To enable, run::</span>

<span class="sd">            import logging</span>
<span class="sd">            logging.getLogger(&quot;calibrated_explanations&quot;).setLevel(logging.INFO)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">init_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">preprocessor_metadata</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;preprocessor_metadata&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">preprocessor_metadata</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_preprocessor_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">preprocessor_metadata</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_preprocessor_metadata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="n">learner</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learner</span> <span class="o">=</span> <span class="n">learner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predict_function</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;predict_function&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predict_function</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">learner</span><span class="o">.</span><span class="n">predict_proba</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;classification&quot;</span> <span class="k">else</span> <span class="n">learner</span><span class="o">.</span><span class="n">predict</span>
            <span class="p">)</span>
        <span class="c1"># Optionally suppress or convert low-level crepes errors into clearer messages.</span>
        <span class="c1"># Caller can pass suppress_crepes_errors=True via kwargs to avoid raising on</span>
        <span class="c1"># crepes broadcasting/shape errors (useful for synthetic tiny datasets).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suppress_crepes_errors</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;suppress_crepes_errors&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oob</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;oob&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oob</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;classification&quot;</span><span class="p">:</span>
                    <span class="n">y_oob_proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learner</span><span class="o">.</span><span class="n">oob_decision_function_</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">y_oob_proba</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">y_oob_proba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="p">):</span>  <span class="c1"># Binary classification</span>
                        <span class="n">y_oob</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_oob_proba</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">y_cal</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Multiclass classification</span>
                        <span class="n">y_oob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_oob_proba</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">safe_isinstance</span><span class="p">(</span><span class="n">y_cal</span><span class="p">,</span> <span class="s2">&quot;pandas.core.arrays.categorical.Categorical&quot;</span><span class="p">):</span>
                            <span class="n">y_oob</span> <span class="o">=</span> <span class="n">y_cal</span><span class="o">.</span><span class="n">categories</span><span class="p">[</span><span class="n">y_oob</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">y_oob</span> <span class="o">=</span> <span class="n">y_oob</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">y_cal</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">y_oob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learner</span><span class="o">.</span><span class="n">oob_prediction_</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_cal</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_oob</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">DataShapeError</span><span class="p">(</span>
                    <span class="s2">&quot;The length of the out-of-bag predictions does not match the length of X_cal.&quot;</span>
                <span class="p">)</span>
            <span class="n">y_cal</span> <span class="o">=</span> <span class="n">y_oob</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span> <span class="o">=</span> <span class="n">x_cal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_cal</span> <span class="o">=</span> <span class="n">y_cal</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;seed&quot;</span><span class="p">,</span> <span class="mi">42</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_percentiles</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sample_percentiles&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bins</span> <span class="o">=</span> <span class="n">bins</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__fast</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fast&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__noise_type</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;noise_type&quot;</span><span class="p">,</span> <span class="s2">&quot;uniform&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__scale_factor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scale_factor&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__severity</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;severity&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">categorical_labels</span> <span class="o">=</span> <span class="n">categorical_labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_labels</span> <span class="o">=</span> <span class="n">class_labels</span>
        <span class="k">if</span> <span class="n">categorical_features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">categorical_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">categorical_features</span> <span class="o">=</span> <span class="n">categorical_labels</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">categorical_features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_to_ignore</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;features_to_ignore&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">feature_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">feature_names</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_X_cal</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X_cal</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span>
                <span class="k">else</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_feature_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">feature_names</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;classification&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_cal</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">str_</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">object_</span><span class="p">))</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_cal</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">y_cal_numeric</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_map</span> <span class="o">=</span> <span class="n">convert_targets_to_numeric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_cal</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">y_cal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_cal_numeric</span>  <span class="c1"># save to _y_cal to avoid append</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">class_labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">label_map</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">class_labels</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">label</span><span class="p">):</span> <span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_cal</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_map</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">class_labels</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">discretizer</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discretized_X_cal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Predeclare attributes for fast mode to satisfy type checkers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_x_cal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaled_x_cal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaled_y_cal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">feature_values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_frequencies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latest_explanation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CalibratedExplanations</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__shap_enabled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__lime_enabled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lime</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lime_exp</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shap</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shap_exp</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reject</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reject&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_difficulty_estimator</span><span class="p">(</span><span class="n">difficulty_estimator</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__set_mode</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">mode</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pyproject_explanations</span> <span class="o">=</span> <span class="n">_read_pyproject_section</span><span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;tool&quot;</span><span class="p">,</span> <span class="s2">&quot;calibrated_explanations&quot;</span><span class="p">,</span> <span class="s2">&quot;explanations&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pyproject_intervals</span> <span class="o">=</span> <span class="n">_read_pyproject_section</span><span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;tool&quot;</span><span class="p">,</span> <span class="s2">&quot;calibrated_explanations&quot;</span><span class="p">,</span> <span class="s2">&quot;intervals&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pyproject_plots</span> <span class="o">=</span> <span class="n">_read_pyproject_section</span><span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;tool&quot;</span><span class="p">,</span> <span class="s2">&quot;calibrated_explanations&quot;</span><span class="p">,</span> <span class="s2">&quot;plots&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_explanation_plugin_overrides</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">mode</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">_plugin&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">_EXPLANATION_MODES</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interval_plugin_override</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;interval_plugin&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fast_interval_plugin_override</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fast_interval_plugin&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_style_override</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plot_style&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bridge_monitors</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_PredictBridgeMonitor</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_explanation_plugin_instances</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_explanation_plugin_identifiers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_explanation_plugin_fallbacks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_plugin_fallbacks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interval_plugin_hints</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interval_plugin_fallbacks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interval_plugin_identifiers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;fast&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_telemetry_interval_sources</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;fast&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interval_preferred_identifier</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;fast&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interval_context_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;fast&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_style_chain</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_explanation_contexts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ExplanationContext</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_explanation_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_telemetry</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_interval_runtime_state</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">_EXPLANATION_MODES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_explanation_plugin_fallbacks</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_explanation_chain</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interval_plugin_fallbacks</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_interval_chain</span><span class="p">(</span><span class="n">fast</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interval_plugin_fallbacks</span><span class="p">[</span><span class="s2">&quot;fast&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_interval_chain</span><span class="p">(</span><span class="n">fast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_style_chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_plot_style_chain</span><span class="p">()</span>

        <span class="c1"># Phase 1A delegation: interval learner initialization via helper</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.calibration_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">initialize_interval_learner</span> <span class="k">as</span> <span class="n">_init_il</span>

        <span class="n">_init_il</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reject_learner</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize_reject_learner</span><span class="p">()</span> <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reject&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_predict_bridge</span> <span class="o">=</span> <span class="n">LegacyPredictBridge</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">init_time</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Plugin resolution helpers (ADR-015)</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_explanation_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the ordered identifier fallback chain for *mode*.&quot;&quot;&quot;</span>
        <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">override</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_explanation_plugin_overrides</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">override</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">override</span><span class="p">:</span>
            <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">override</span><span class="p">)</span>

        <span class="n">env_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;CE_EXPLANATION_PLUGIN_</span><span class="si">{</span><span class="n">mode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">env_value</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">env_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_value</span><span class="p">:</span>
            <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">env_value</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="n">entries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_split_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env_key</span><span class="si">}</span><span class="s2">_FALLBACKS&quot;</span><span class="p">)))</span>

        <span class="n">py_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyproject_explanations</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">py_value</span> <span class="o">=</span> <span class="n">py_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">py_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">py_value</span><span class="p">:</span>
            <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">py_value</span><span class="p">)</span>
        <span class="n">entries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_coerce_string_tuple</span><span class="p">(</span><span class="n">py_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">_fallbacks&quot;</span><span class="p">)))</span>

        <span class="c1"># Deduplicate while maintaining order and extend using metadata fallbacks</span>
        <span class="n">seen</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">expanded</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">identifier</span> <span class="ow">or</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">expanded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
            <span class="n">descriptor</span> <span class="o">=</span> <span class="n">find_explanation_descriptor</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">descriptor</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fallback</span> <span class="ow">in</span> <span class="n">_coerce_string_tuple</span><span class="p">(</span><span class="n">descriptor</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fallbacks&quot;</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">fallback</span> <span class="ow">and</span> <span class="n">fallback</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                        <span class="n">expanded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fallback</span><span class="p">)</span>
                        <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fallback</span><span class="p">)</span>

        <span class="n">default_identifier</span> <span class="o">=</span> <span class="n">_DEFAULT_EXPLANATION_IDENTIFIERS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">default_identifier</span> <span class="ow">and</span> <span class="n">default_identifier</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fast&quot;</span> <span class="ow">and</span> <span class="n">find_explanation_descriptor</span><span class="p">(</span><span class="n">default_identifier</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">expanded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">default_identifier</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">expanded</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_interval_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">fast</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the ordered interval plugin chain for the requested mode.&quot;&quot;&quot;</span>
        <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">override</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fast_interval_plugin_override</span> <span class="k">if</span> <span class="n">fast</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval_plugin_override</span>
        <span class="n">preferred_identifier</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">override</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">override</span><span class="p">:</span>
            <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">override</span><span class="p">)</span>
            <span class="n">preferred_identifier</span> <span class="o">=</span> <span class="n">override</span>

        <span class="n">env_key</span> <span class="o">=</span> <span class="s2">&quot;CE_INTERVAL_PLUGIN_FAST&quot;</span> <span class="k">if</span> <span class="n">fast</span> <span class="k">else</span> <span class="s2">&quot;CE_INTERVAL_PLUGIN&quot;</span>
        <span class="n">env_value</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">env_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_value</span><span class="p">:</span>
            <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">env_value</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">preferred_identifier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">preferred_identifier</span> <span class="o">=</span> <span class="n">env_value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">entries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_split_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env_key</span><span class="si">}</span><span class="s2">_FALLBACKS&quot;</span><span class="p">)))</span>

        <span class="n">py_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyproject_intervals</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">py_key</span> <span class="o">=</span> <span class="s2">&quot;fast&quot;</span> <span class="k">if</span> <span class="n">fast</span> <span class="k">else</span> <span class="s2">&quot;default&quot;</span>
        <span class="n">py_value</span> <span class="o">=</span> <span class="n">py_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">py_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">py_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">py_value</span><span class="p">:</span>
            <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">py_value</span><span class="p">)</span>
        <span class="n">entries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_coerce_string_tuple</span><span class="p">(</span><span class="n">py_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">py_key</span><span class="si">}</span><span class="s2">_fallbacks&quot;</span><span class="p">)))</span>

        <span class="n">default_identifier</span> <span class="o">=</span> <span class="s2">&quot;core.interval.fast&quot;</span> <span class="k">if</span> <span class="n">fast</span> <span class="k">else</span> <span class="s2">&quot;core.interval.legacy&quot;</span>
        <span class="n">seen</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">ordered</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">identifier</span> <span class="ow">and</span> <span class="n">identifier</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="n">ordered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
                <span class="n">descriptor</span> <span class="o">=</span> <span class="n">find_interval_descriptor</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">descriptor</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">fallback</span> <span class="ow">in</span> <span class="n">_coerce_string_tuple</span><span class="p">(</span><span class="n">descriptor</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fallbacks&quot;</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">fallback</span> <span class="ow">and</span> <span class="n">fallback</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                            <span class="n">ordered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fallback</span><span class="p">)</span>
                            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fallback</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">default_identifier</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fast</span> <span class="ow">and</span> <span class="n">find_interval_descriptor</span><span class="p">(</span><span class="n">default_identifier</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ordered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">default_identifier</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;fast&quot;</span> <span class="k">if</span> <span class="n">fast</span> <span class="k">else</span> <span class="s2">&quot;default&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interval_preferred_identifier</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">preferred_identifier</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ordered</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_plot_style_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the ordered plot style fallback chain.&quot;&quot;&quot;</span>
        <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_plot_style_override</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_style_override</span><span class="p">:</span>
            <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_plot_style_override</span><span class="p">)</span>

        <span class="n">env_value</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CE_PLOT_STYLE&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_value</span><span class="p">:</span>
            <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">env_value</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="n">entries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_split_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CE_PLOT_STYLE_FALLBACKS&quot;</span><span class="p">)))</span>

        <span class="n">py_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyproject_plots</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">py_value</span> <span class="o">=</span> <span class="n">py_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;style&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">py_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">py_value</span><span class="p">:</span>
            <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">py_value</span><span class="p">)</span>
        <span class="n">entries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_coerce_string_tuple</span><span class="p">(</span><span class="n">py_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;style_fallbacks&quot;</span><span class="p">)))</span>
        <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;legacy&quot;</span><span class="p">)</span>
        <span class="n">seen</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">ordered</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">identifier</span> <span class="ow">and</span> <span class="n">identifier</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="n">ordered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;plot_spec.default&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;legacy&quot;</span> <span class="ow">in</span> <span class="n">ordered</span><span class="p">:</span>
                <span class="n">legacy_index</span> <span class="o">=</span> <span class="n">ordered</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;legacy&quot;</span><span class="p">)</span>
                <span class="n">ordered</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">legacy_index</span><span class="p">,</span> <span class="s2">&quot;plot_spec.default&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ordered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;plot_spec.default&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;legacy&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ordered</span><span class="p">:</span>
            <span class="n">ordered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;legacy&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ordered</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_interval_runtime_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure interval tracking members exist for legacy instances.&quot;&quot;&quot;</span>
        <span class="n">storage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="k">if</span> <span class="s2">&quot;_interval_plugin_hints&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">storage</span><span class="p">:</span>
            <span class="n">storage</span><span class="p">[</span><span class="s2">&quot;_interval_plugin_hints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s2">&quot;_interval_plugin_fallbacks&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">storage</span><span class="p">:</span>
            <span class="n">storage</span><span class="p">[</span><span class="s2">&quot;_interval_plugin_fallbacks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s2">&quot;_interval_plugin_identifiers&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">storage</span><span class="p">:</span>
            <span class="n">storage</span><span class="p">[</span><span class="s2">&quot;_interval_plugin_identifiers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;fast&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">if</span> <span class="s2">&quot;_telemetry_interval_sources&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">storage</span><span class="p">:</span>
            <span class="n">storage</span><span class="p">[</span><span class="s2">&quot;_telemetry_interval_sources&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;fast&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">if</span> <span class="s2">&quot;_interval_preferred_identifier&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">storage</span><span class="p">:</span>
            <span class="n">storage</span><span class="p">[</span><span class="s2">&quot;_interval_preferred_identifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;fast&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">if</span> <span class="s2">&quot;_interval_context_metadata&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">storage</span><span class="p">:</span>
            <span class="n">storage</span><span class="p">[</span><span class="s2">&quot;_interval_context_metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;fast&quot;</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_coerce_plugin_override</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">override</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalise a plugin override into an instance when possible.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">override</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">override</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">override</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">override</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">override</span><span class="p">,</span> <span class="s2">&quot;plugin_meta&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">candidate</span> <span class="o">=</span> <span class="n">override</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c1"># pragma: no cover - defensive</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                    <span class="s2">&quot;Callable explanation plugin override raised an exception&quot;</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>
            <span class="k">return</span> <span class="n">candidate</span>
        <span class="k">return</span> <span class="n">override</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_explanation_runtime_metadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return an error message if *metadata* is incompatible at runtime.&quot;&quot;&quot;</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">identifier</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">((</span><span class="n">metadata</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&lt;anonymous&gt;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">: plugin metadata unavailable&quot;</span>

        <span class="n">schema_version</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schema_version&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">schema_version</span> <span class="o">!=</span> <span class="n">EXPLANATION_PROTOCOL_VERSION</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">: explanation schema_version </span><span class="si">{</span><span class="n">schema_version</span><span class="si">}</span><span class="s2"> unsupported; &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;expected </span><span class="si">{</span><span class="n">EXPLANATION_PROTOCOL_VERSION</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">tasks</span> <span class="o">=</span> <span class="n">_coerce_string_tuple</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tasks&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">: plugin metadata missing tasks declaration&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;both&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="n">declared</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">: does not support task &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="si">}</span><span class="s2">&#39; &quot;</span> <span class="sa">f</span><span class="s2">&quot;(declared: </span><span class="si">{</span><span class="n">declared</span><span class="si">}</span><span class="s2">)&quot;</span>

        <span class="n">modes</span> <span class="o">=</span> <span class="n">_coerce_string_tuple</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;modes&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">modes</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">: plugin metadata missing modes declaration&quot;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">modes</span><span class="p">:</span>
            <span class="n">declared</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modes</span><span class="p">)</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">: does not declare mode &#39;</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&#39; (modes: </span><span class="si">{</span><span class="n">declared</span><span class="si">}</span><span class="s2">)&quot;</span>

        <span class="n">capabilities</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capabilities&quot;</span><span class="p">)</span>
        <span class="n">cap_set</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">capabilities</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">capability</span> <span class="ow">in</span> <span class="n">capabilities</span><span class="p">:</span>
                <span class="n">cap_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">capability</span><span class="p">))</span>

        <span class="n">missing</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s2">&quot;explain&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cap_set</span><span class="p">:</span>
            <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;explain&quot;</span><span class="p">)</span>
        <span class="n">mode_cap</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;explanation:</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">mode_cap</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cap_set</span><span class="p">:</span>
            <span class="n">alt_mode_cap</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mode:</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">alt_mode_cap</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cap_set</span><span class="p">:</span>
                <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mode_cap</span><span class="p">)</span>
        <span class="n">task_cap</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;task:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">task_cap</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cap_set</span> <span class="ow">and</span> <span class="s2">&quot;task:both&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cap_set</span><span class="p">:</span>
            <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task_cap</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">: missing required capabilities </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">missing</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_instantiate_plugin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prototype</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Best-effort instantiation that avoids sharing state across explainers.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">prototype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">prototype</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prototype</span><span class="p">,</span> <span class="s2">&quot;plugin_meta&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">prototype</span>
        <span class="n">plugin_cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">prototype</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">plugin_cls</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>

                <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">prototype</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover - defensive</span>
                <span class="k">return</span> <span class="n">prototype</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_gather_interval_hints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">fast</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return interval dependency hints collected from explanation plugins.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fast</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval_plugin_hints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fast&quot;</span><span class="p">,</span> <span class="p">())</span>
        <span class="n">ordered</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">seen</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;factual&quot;</span><span class="p">,</span> <span class="s2">&quot;alternative&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval_plugin_hints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="p">()):</span>  <span class="c1"># noqa: B020</span>
                <span class="k">if</span> <span class="n">identifier</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                    <span class="n">ordered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
                    <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ordered</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_interval_runtime_metadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fast</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate interval plugin metadata for the current execution.&quot;&quot;&quot;</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">identifier</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">((</span><span class="n">metadata</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&lt;anonymous&gt;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">: interval metadata unavailable&quot;</span>

        <span class="n">schema_version</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schema_version&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">schema_version</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">: unsupported interval schema_version </span><span class="si">{</span><span class="n">schema_version</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">modes</span> <span class="o">=</span> <span class="n">_coerce_string_tuple</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;modes&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">modes</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">: plugin metadata missing modes declaration&quot;</span>
        <span class="n">required_mode</span> <span class="o">=</span> <span class="s2">&quot;regression&quot;</span> <span class="k">if</span> <span class="s2">&quot;regression&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="k">else</span> <span class="s2">&quot;classification&quot;</span>
        <span class="k">if</span> <span class="n">required_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">modes</span><span class="p">:</span>
            <span class="n">declared</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modes</span><span class="p">)</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">: does not support mode &#39;</span><span class="si">{</span><span class="n">required_mode</span><span class="si">}</span><span class="s2">&#39; (modes: </span><span class="si">{</span><span class="n">declared</span><span class="si">}</span><span class="s2">)&quot;</span>

        <span class="n">capabilities</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">_coerce_string_tuple</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capabilities&quot;</span><span class="p">)))</span>
        <span class="n">required_cap</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;interval:regression&quot;</span> <span class="k">if</span> <span class="s2">&quot;regression&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="k">else</span> <span class="s2">&quot;interval:classification&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">required_cap</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">capabilities</span><span class="p">:</span>
            <span class="n">declared</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">capabilities</span><span class="p">))</span> <span class="ow">or</span> <span class="s2">&quot;&lt;none&gt;&quot;</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">: missing capability &#39;</span><span class="si">{</span><span class="n">required_cap</span><span class="si">}</span><span class="s2">&#39; (capabilities: </span><span class="si">{</span><span class="n">declared</span><span class="si">}</span><span class="s2">)&quot;</span>

        <span class="k">if</span> <span class="n">fast</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fast_compatible&quot;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">: not marked fast_compatible&quot;</span>
        <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requires_bins&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">: requires bins but explainer has none configured&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_interval_plugin</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">fast</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">hints</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolve the interval plugin for the requested execution path.&quot;&quot;&quot;</span>
        <span class="n">ensure_builtin_plugins</span><span class="p">()</span>

        <span class="n">raw_override</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fast_interval_plugin_override</span> <span class="k">if</span> <span class="n">fast</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval_plugin_override</span>
        <span class="p">)</span>
        <span class="n">override</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_plugin_override</span><span class="p">(</span><span class="n">raw_override</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">override</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">override</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">override</span><span class="p">,</span> <span class="s2">&quot;plugin_meta&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">override</span><span class="p">,</span> <span class="n">identifier</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_override</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">preferred_identifier</span> <span class="o">=</span> <span class="n">raw_override</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;fast&quot;</span> <span class="k">if</span> <span class="n">fast</span> <span class="k">else</span> <span class="s2">&quot;default&quot;</span>
            <span class="n">preferred_identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval_preferred_identifier</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">chain</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interval_plugin_fallbacks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fast&quot;</span> <span class="k">if</span> <span class="n">fast</span> <span class="k">else</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="p">()))</span>
        <span class="k">if</span> <span class="n">hints</span><span class="p">:</span>
            <span class="n">ordered</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">seen</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">hints</span><span class="p">)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">chain</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">identifier</span> <span class="ow">and</span> <span class="n">identifier</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                    <span class="n">ordered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
                    <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
            <span class="n">chain</span> <span class="o">=</span> <span class="n">ordered</span>

        <span class="n">errors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_identifier_denied</span><span class="p">(</span><span class="n">identifier</span><span class="p">):</span>
                <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">identifier</span><span class="si">}</span><span class="s2">: denied via CE_DENY_PLUGIN&quot;</span>
                <span class="k">if</span> <span class="n">preferred_identifier</span> <span class="o">==</span> <span class="n">identifier</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;Interval plugin override failed: &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">)</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">descriptor</span> <span class="o">=</span> <span class="n">find_interval_descriptor</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
            <span class="n">plugin</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">metadata</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">preferred</span> <span class="o">=</span> <span class="n">preferred_identifier</span> <span class="o">==</span> <span class="n">identifier</span>
            <span class="k">if</span> <span class="n">descriptor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">metadata</span>
                <span class="k">if</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">trusted</span> <span class="ow">or</span> <span class="n">preferred</span><span class="p">:</span>
                    <span class="n">plugin</span> <span class="o">=</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">plugin</span>
            <span class="k">if</span> <span class="n">plugin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">preferred</span><span class="p">:</span>
                    <span class="n">plugin</span> <span class="o">=</span> <span class="n">find_interval_plugin</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plugin</span> <span class="o">=</span> <span class="n">find_interval_plugin_trusted</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plugin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">identifier</span><span class="si">}</span><span class="s2">: not registered&quot;</span>
                <span class="k">if</span> <span class="n">preferred_identifier</span> <span class="o">==</span> <span class="n">identifier</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;Interval plugin override failed: &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">)</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">meta_source</span> <span class="o">=</span> <span class="n">metadata</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="s2">&quot;plugin_meta&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_interval_runtime_metadata</span><span class="p">(</span>
                <span class="n">meta_source</span><span class="p">,</span>
                <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span>
                <span class="n">fast</span><span class="o">=</span><span class="n">fast</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">preferred_identifier</span> <span class="o">==</span> <span class="n">identifier</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">plugin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instantiate_plugin</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">identifier</span>

        <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
            <span class="s2">&quot;Unable to resolve interval plugin for &quot;</span>
            <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;fast&quot;</span> <span class="k">if</span> <span class="n">fast</span> <span class="k">else</span> <span class="s2">&quot;default&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; mode. Tried: &quot;</span>
            <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chain</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;&lt;none&gt;&quot;</span><span class="p">,))</span>
            <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;; errors: &quot;</span> <span class="o">+</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="k">if</span> <span class="n">errors</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_interval_context</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">fast</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IntervalCalibratorContext</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct the frozen interval calibrator context.&quot;&quot;&quot;</span>
        <span class="n">calibration_splits</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_cal</span><span class="p">),)</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;calibration&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">}</span>
        <span class="n">difficulty</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;estimator&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">difficulty_estimator</span><span class="p">}</span>
        <span class="n">fast_flags</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fast&quot;</span><span class="p">:</span> <span class="n">fast</span><span class="p">}</span>
        <span class="n">residuals</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;fast&quot;</span> <span class="k">if</span> <span class="n">fast</span> <span class="k">else</span> <span class="s2">&quot;default&quot;</span>
        <span class="n">stored_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interval_context_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="n">enriched_metadata</span> <span class="o">=</span> <span class="n">stored_metadata</span>
        <span class="n">enriched_metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
        <span class="n">enriched_metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;task&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">enriched_metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">enriched_metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;predict_function&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;predict_function&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">enriched_metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;difficulty_estimator&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">difficulty_estimator</span><span class="p">)</span>
        <span class="n">enriched_metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;explainer&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">enriched_metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;categorical_features&quot;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">categorical_features</span><span class="p">))</span>
        <span class="n">enriched_metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;num_features&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">)</span>
        <span class="n">enriched_metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
            <span class="s2">&quot;noise_config&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;noise_type&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_CalibratedExplainer__noise_type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="s2">&quot;scale_factor&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_CalibratedExplainer__scale_factor&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="s2">&quot;severity&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_CalibratedExplainer__severity&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;seed&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="s2">&quot;rng&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;rng&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">fast</span><span class="p">:</span>
            <span class="n">existing_fast</span> <span class="o">=</span> <span class="n">enriched_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;existing_fast_calibrators&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">existing_fast</span><span class="p">:</span>
                <span class="n">stored_fast</span> <span class="o">=</span> <span class="n">stored_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fast_calibrators&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">stored_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;existing_fast_calibrators&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">stored_fast</span><span class="p">:</span>
                    <span class="n">existing_fast</span> <span class="o">=</span> <span class="n">stored_fast</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">existing_fast</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">existing_fast</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">existing_fast</span><span class="p">:</span>
                <span class="n">enriched_metadata</span><span class="p">[</span><span class="s2">&quot;existing_fast_calibrators&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">existing_fast</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">IntervalCalibratorContext</span><span class="p">(</span>
            <span class="n">learner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learner</span><span class="p">,</span>
            <span class="n">calibration_splits</span><span class="o">=</span><span class="n">calibration_splits</span><span class="p">,</span>
            <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
            <span class="n">residuals</span><span class="o">=</span><span class="n">residuals</span><span class="p">,</span>
            <span class="n">difficulty</span><span class="o">=</span><span class="n">difficulty</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">enriched_metadata</span><span class="p">,</span>
            <span class="n">fast_flags</span><span class="o">=</span><span class="n">fast_flags</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_obtain_interval_calibrator</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">fast</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolve and instantiate the interval calibrator for the active mode.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_interval_runtime_state</span><span class="p">()</span>
        <span class="n">hints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gather_interval_hints</span><span class="p">(</span><span class="n">fast</span><span class="o">=</span><span class="n">fast</span><span class="p">)</span>
        <span class="n">plugin</span><span class="p">,</span> <span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_interval_plugin</span><span class="p">(</span><span class="n">fast</span><span class="o">=</span><span class="n">fast</span><span class="p">,</span> <span class="n">hints</span><span class="o">=</span><span class="n">hints</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_interval_context</span><span class="p">(</span><span class="n">fast</span><span class="o">=</span><span class="n">fast</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">calibrator</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">fast</span><span class="o">=</span><span class="n">fast</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c1"># pragma: no cover - defensive guard</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Interval plugin execution failed for </span><span class="si">{</span><span class="s1">&#39;fast&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">fast</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="si">}</span><span class="s2"> mode: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_capture_interval_calibrators</span><span class="p">(</span>
            <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
            <span class="n">calibrator</span><span class="o">=</span><span class="n">calibrator</span><span class="p">,</span>
            <span class="n">fast</span><span class="o">=</span><span class="n">fast</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;fast&quot;</span> <span class="k">if</span> <span class="n">fast</span> <span class="k">else</span> <span class="s2">&quot;default&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interval_plugin_identifiers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_telemetry_interval_sources</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">identifier</span>
        <span class="n">metadata_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">metadata_dict</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">metadata</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadata_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fast</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">calibrator</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">calibrator</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
                <span class="n">calibrators_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">calibrator</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">calibrators_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">calibrator</span><span class="p">,)</span>
            <span class="n">metadata_dict</span><span class="p">[</span><span class="s2">&quot;fast_calibrators&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calibrators_tuple</span>
            <span class="n">metadata_dict</span><span class="p">[</span><span class="s2">&quot;existing_fast_calibrators&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calibrators_tuple</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadata_dict</span><span class="p">[</span><span class="s2">&quot;calibrator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calibrator</span>
        <span class="c1"># persist captured metadata for future invocations without sharing references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interval_context_metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">metadata_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metadata_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">context</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metadata_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">calibrator</span><span class="p">,</span> <span class="n">identifier</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_capture_interval_calibrators</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">IntervalCalibratorContext</span><span class="p">,</span>
        <span class="n">calibrator</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">fast</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Record the returned calibrator inside the interval context metadata.&quot;&quot;&quot;</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">metadata</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">fast</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">calibrator</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">calibrator</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;fast_calibrators&quot;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">calibrator</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">calibrator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;fast_calibrators&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">calibrator</span><span class="p">,))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;calibrator&quot;</span><span class="p">,</span> <span class="n">calibrator</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_explanation_plugin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolve or instantiate the plugin handling *mode*.&quot;&quot;&quot;</span>
        <span class="n">ensure_builtin_plugins</span><span class="p">()</span>

        <span class="n">raw_override</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_explanation_plugin_overrides</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">override</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_plugin_override</span><span class="p">(</span><span class="n">raw_override</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">override</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">override</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">plugin</span> <span class="o">=</span> <span class="n">override</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="s2">&quot;plugin_meta&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">identifier</span>

        <span class="n">preferred_identifier</span> <span class="o">=</span> <span class="n">raw_override</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_override</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_explanation_plugin_fallbacks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">chain</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fast&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Fast explanation plugin &#39;core.explanation.fast&#39; is not registered. &quot;</span>
                <span class="s2">&quot;Install the external plugins extra with ``pip install </span><span class="se">\&quot;</span><span class="s2">calibrated-explanations[external-plugins]</span><span class="se">\&quot;</span><span class="s2">`` &quot;</span>
                <span class="s2">&quot;and call ``external_plugins.fast_explanations.register()`` or rerun &quot;</span>
                <span class="s2">&quot;``explain_fast(..., _use_plugin=False)`` to fall back to the legacy path.&quot;</span>
            <span class="p">)</span>
        <span class="n">errors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">:</span>
            <span class="n">is_preferred</span> <span class="o">=</span> <span class="n">preferred_identifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">identifier</span> <span class="o">==</span> <span class="n">preferred_identifier</span>
            <span class="k">if</span> <span class="n">is_identifier_denied</span><span class="p">(</span><span class="n">identifier</span><span class="p">):</span>
                <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">identifier</span><span class="si">}</span><span class="s2">: denied via CE_DENY_PLUGIN&quot;</span>
                <span class="k">if</span> <span class="n">is_preferred</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                        <span class="s2">&quot;Explanation plugin override failed: &quot;</span> <span class="o">+</span> <span class="n">message</span>
                    <span class="p">)</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">descriptor</span> <span class="o">=</span> <span class="n">find_explanation_descriptor</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
            <span class="n">metadata</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">plugin</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">descriptor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">metadata</span>
                <span class="k">if</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">trusted</span><span class="p">:</span>
                    <span class="n">plugin</span> <span class="o">=</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">plugin</span>
            <span class="k">if</span> <span class="n">plugin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plugin</span> <span class="o">=</span> <span class="n">find_explanation_plugin</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plugin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">identifier</span><span class="si">}</span><span class="s2">: not registered&quot;</span>
                <span class="k">if</span> <span class="n">is_preferred</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;Explanation plugin override failed: &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">)</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">meta_source</span> <span class="o">=</span> <span class="n">metadata</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="s2">&quot;plugin_meta&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_explanation_runtime_metadata</span><span class="p">(</span>
                <span class="n">meta_source</span><span class="p">,</span>
                <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_preferred</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">plugin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instantiate_plugin</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">supports</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">supports_mode</span>
            <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">identifier</span><span class="si">}</span><span class="s2">: missing supports_mode (</span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">supports</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">):</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">identifier</span><span class="si">}</span><span class="s2">: mode &#39;</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&#39; unsupported for task </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c1"># pragma: no cover - defensive</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">identifier</span><span class="si">}</span><span class="s2">: error during supports_mode (</span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">return</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">identifier</span>

        <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
            <span class="s2">&quot;Unable to resolve explanation plugin for mode &#39;&quot;</span>
            <span class="o">+</span> <span class="n">mode</span>
            <span class="o">+</span> <span class="s2">&quot;&#39;. Tried: &quot;</span>
            <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chain</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;&lt;none&gt;&quot;</span><span class="p">,))</span>
            <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;; errors: &quot;</span> <span class="o">+</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="k">if</span> <span class="n">errors</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_explanation_plugin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the plugin instance for *mode*, initialising on demand.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_explanation_plugin_instances</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_explanation_plugin_instances</span><span class="p">[</span>
                <span class="n">mode</span>
            <span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_explanation_plugin_identifiers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>

        <span class="n">plugin</span><span class="p">,</span> <span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_explanation_plugin</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">identifier</span><span class="p">:</span>
            <span class="n">descriptor</span> <span class="o">=</span> <span class="n">find_explanation_descriptor</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">descriptor</span><span class="p">:</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">metadata</span>
                <span class="n">interval_dependency</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;interval_dependency&quot;</span><span class="p">)</span>
                <span class="n">hints</span> <span class="o">=</span> <span class="n">_coerce_string_tuple</span><span class="p">(</span><span class="n">interval_dependency</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">hints</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_interval_plugin_hints</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">hints</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="s2">&quot;plugin_meta&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="s2">&quot;plugin_meta&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_explanation_runtime_metadata</span><span class="p">(</span>
            <span class="n">metadata</span><span class="p">,</span>
            <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">identifier</span><span class="p">:</span>
            <span class="n">hints</span> <span class="o">=</span> <span class="n">_coerce_string_tuple</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;interval_dependency&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">hints</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_interval_plugin_hints</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">hints</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_explanation_context</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">plugin</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Explanation plugin initialisation failed for mode &#39;</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_explanation_plugin_instances</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">plugin</span>
        <span class="k">if</span> <span class="n">identifier</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_explanation_plugin_identifiers</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_explanation_contexts</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span>
        <span class="k">return</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">identifier</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_explanation_context</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">plugin</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExplanationContext</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct the immutable context passed to explanation plugins.&quot;&quot;&quot;</span>
        <span class="n">helper_handles</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;explainer&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">}</span>
        <span class="n">interval_settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;dependencies&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval_plugin_hints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="p">()),</span>
        <span class="p">}</span>
        <span class="n">plot_chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive_plot_chain</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_plugin_fallbacks</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_chain</span>
        <span class="n">plot_settings</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fallbacks&quot;</span><span class="p">:</span> <span class="n">plot_chain</span><span class="p">}</span>

        <span class="n">monitor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bridge_monitors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">monitor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">monitor</span> <span class="o">=</span> <span class="n">_PredictBridgeMonitor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_predict_bridge</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bridge_monitors</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">monitor</span>

        <span class="n">context</span> <span class="o">=</span> <span class="n">ExplanationContext</span><span class="p">(</span>
            <span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">feature_names</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">),</span>
            <span class="n">categorical_features</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">categorical_features</span><span class="p">),</span>
            <span class="n">categorical_labels</span><span class="o">=</span><span class="p">(</span>
                <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">categorical_labels</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">categorical_labels</span>
                <span class="k">else</span> <span class="p">{}</span>
            <span class="p">),</span>
            <span class="n">discretizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">discretizer</span><span class="p">,</span>
            <span class="n">helper_handles</span><span class="o">=</span><span class="n">helper_handles</span><span class="p">,</span>
            <span class="n">predict_bridge</span><span class="o">=</span><span class="n">monitor</span><span class="p">,</span>
            <span class="n">interval_settings</span><span class="o">=</span><span class="n">interval_settings</span><span class="p">,</span>
            <span class="n">plot_settings</span><span class="o">=</span><span class="n">plot_settings</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_derive_plot_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return plot fallback chain seeded by plugin metadata.&quot;&quot;&quot;</span>
        <span class="n">preferred</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">identifier</span><span class="p">:</span>
            <span class="n">descriptor</span> <span class="o">=</span> <span class="n">find_explanation_descriptor</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">descriptor</span><span class="p">:</span>
                <span class="n">plot_dependency</span> <span class="o">=</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plot_dependency&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">hint</span> <span class="ow">in</span> <span class="n">_coerce_string_tuple</span><span class="p">(</span><span class="n">plot_dependency</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">hint</span><span class="p">:</span>
                        <span class="n">preferred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span>
        <span class="n">base_chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_style_chain</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;legacy&quot;</span><span class="p">,)</span>
        <span class="n">seen</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">ordered</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">preferred</span><span class="p">)</span> <span class="o">+</span> <span class="n">base_chain</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">and</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="n">ordered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ordered</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_instance_telemetry_payload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">explanations</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract telemetry details from the first explanation instance, if present.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">first_explanation</span> <span class="o">=</span> <span class="n">explanations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># type: ignore[index]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover - defensive: empty or non-indexable containers</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">first_explanation</span><span class="p">,</span> <span class="s2">&quot;to_telemetry&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">builder</span><span class="p">):</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">builder</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">payload</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_infer_explanation_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Infer the explanation mode based on the active discretizer.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">discretizer</span><span class="p">,</span> <span class="p">(</span><span class="n">EntropyDiscretizer</span><span class="p">,</span> <span class="n">RegressorDiscretizer</span><span class="p">)):</span>
            <span class="k">return</span> <span class="s2">&quot;alternative&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;factual&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_invoke_explanation_plugin</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">threshold</span><span class="p">,</span>
        <span class="n">low_high_percentiles</span><span class="p">,</span>
        <span class="n">bins</span><span class="p">,</span>
        <span class="n">features_to_ignore</span><span class="p">,</span>
        <span class="n">extras</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CalibratedExplanations</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Invoke the configured plugin for *mode* and materialise the batch.&quot;&quot;&quot;</span>
        <span class="n">plugin</span><span class="p">,</span> <span class="n">_identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_explanation_plugin</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">ExplanationRequest</span><span class="p">(</span>
            <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
            <span class="n">low_high_percentiles</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">low_high_percentiles</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">low_high_percentiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
            <span class="n">features_to_ignore</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">features_to_ignore</span> <span class="ow">or</span> <span class="p">[]),</span>
            <span class="n">extras</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">extras</span> <span class="ow">or</span> <span class="p">{}),</span>
        <span class="p">)</span>
        <span class="n">monitor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bridge_monitors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">monitor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">monitor</span><span class="o">.</span><span class="n">reset_usage</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">explain_batch</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Explanation plugin execution failed for mode &#39;</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">validate_explanation_batch</span><span class="p">(</span>
                <span class="n">batch</span><span class="p">,</span>
                <span class="n">expected_mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                <span class="n">expected_task</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Explanation plugin for mode &#39;</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&#39; returned an invalid batch: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">collection_metadata</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;task&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">interval_key</span> <span class="o">=</span> <span class="s2">&quot;fast&quot;</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fast&quot;</span> <span class="k">else</span> <span class="s2">&quot;default&quot;</span>
        <span class="n">interval_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_telemetry_interval_sources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">interval_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">interval_source</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;interval_source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interval_source</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;proba_source&quot;</span><span class="p">,</span> <span class="n">interval_source</span><span class="p">)</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
            <span class="s2">&quot;interval_dependencies&quot;</span><span class="p">,</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interval_plugin_hints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="p">())),</span>
        <span class="p">)</span>
        <span class="n">preprocessor_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor_metadata</span>
        <span class="k">if</span> <span class="n">preprocessor_meta</span><span class="p">:</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;preprocessor&quot;</span><span class="p">,</span> <span class="n">preprocessor_meta</span><span class="p">)</span>
        <span class="n">plot_chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_plugin_fallbacks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_chain</span><span class="p">:</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;plot_fallbacks&quot;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">plot_chain</span><span class="p">))</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;plot_source&quot;</span><span class="p">,</span> <span class="n">plot_chain</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">telemetry_payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
            <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
            <span class="s2">&quot;interval_source&quot;</span><span class="p">:</span> <span class="n">interval_source</span><span class="p">,</span>
            <span class="s2">&quot;proba_source&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;proba_source&quot;</span><span class="p">),</span>
            <span class="s2">&quot;plot_source&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plot_source&quot;</span><span class="p">),</span>
            <span class="s2">&quot;plot_fallbacks&quot;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">plot_chain</span> <span class="ow">or</span> <span class="p">()),</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">preprocessor_meta</span><span class="p">:</span>
            <span class="n">telemetry_payload</span><span class="p">[</span><span class="s2">&quot;preprocessor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">preprocessor_meta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_telemetry</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">telemetry_payload</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">monitor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">monitor</span><span class="o">.</span><span class="n">used</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Explanation plugin for mode &#39;&quot;</span>
                <span class="o">+</span> <span class="n">mode</span>
                <span class="o">+</span> <span class="s2">&quot;&#39; did not use the calibrated predict bridge&quot;</span>
            <span class="p">)</span>
        <span class="n">container_cls</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">container_cls</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">container_cls</span><span class="p">,</span> <span class="s2">&quot;from_batch&quot;</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">container_cls</span><span class="o">.</span><span class="n">from_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="n">instance_payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_instance_telemetry_payload</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">instance_payload</span><span class="p">:</span>
                <span class="n">telemetry_payload</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">instance_payload</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_last_telemetry</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">instance_payload</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">telemetry</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">telemetry_payload</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">latest_explanation</span> <span class="o">=</span> <span class="n">result</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_explanation_mode</span> <span class="o">=</span> <span class="n">mode</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;Explanation plugin returned a batch that cannot be materialised&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">runtime_telemetry</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the most recent telemetry payload reported by the explainer.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_telemetry</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">preprocessor_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the telemetry-safe preprocessing snapshot if available.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocessor_metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_preprocessor_metadata</span><span class="p">)</span>

<div class="viewcode-block" id="CalibratedExplainer.set_preprocessor_metadata">
<a class="viewcode-back" href="../../../_autosummary/calibrated_explanations.core.CalibratedExplainer.html#calibrated_explanations.core.CalibratedExplainer.set_preprocessor_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_preprocessor_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the stored preprocessing metadata snapshot.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_preprocessor_metadata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_preprocessor_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">x_cal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the calibration input data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        array-like</span>
<span class="sd">            The calibration input data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__X_cal</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X_cal</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_X_cal</span>

    <span class="nd">@x_cal</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">x_cal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the calibration input data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value : array-like of shape (n_samples, n_features)</span>
<span class="sd">            The new calibration input data.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the number of features in value does not match the existing calibration data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">safe_isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;pandas.core.frame.DataFrame&quot;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">values</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_X_cal</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X_cal</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__X_cal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_X_cal</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">y_cal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the calibration target data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        array-like</span>
<span class="sd">            The calibration target data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_cal</span>

    <span class="nd">@y_cal</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">y_cal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the calibration target data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value : array-like of shape (n_samples,)</span>
<span class="sd">            The new calibration target data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">safe_isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;pandas.core.frame.DataFrame&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_y_cal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_y_cal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="CalibratedExplainer.append_cal">
<a class="viewcode-back" href="../../../_autosummary/calibrated_explanations.core.CalibratedExplainer.html#calibrated_explanations.core.CalibratedExplainer.append_cal">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">append_cal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Append new calibration data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : array-like of shape (n_samples, n_features)</span>
<span class="sd">            The new calibration input data to append.</span>
<span class="sd">        y : array-like of shape (n_samples,)</span>
<span class="sd">            The new calibration target data to append.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DataShapeError</span><span class="p">(</span><span class="s2">&quot;Number of features must match existing calibration data&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_cal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">y_cal</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">num_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the number of features in the calibration data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            The number of features in the calibration data. For dictionary input,</span>
<span class="sd">            returns the number of keys. For array input, returns the number of columns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X_cal</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X_cal</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X_cal</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">feature_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the feature names.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            The list of feature names. If no feature names were provided during initialization,</span>
<span class="sd">            returns None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feature_names</span>

<div class="viewcode-block" id="CalibratedExplainer.reinitialize">
<a class="viewcode-back" href="../../../_autosummary/calibrated_explanations.core.CalibratedExplainer.html#calibrated_explanations.core.CalibratedExplainer.reinitialize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reinitialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">learner</span><span class="p">,</span> <span class="n">xs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reinitialize the explainer with a new learner.</span>

<span class="sd">        This is useful when the learner is updated or retrained and the explainer needs to be reinitialized.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        learner : predictive learner</span>
<span class="sd">            A predictive learner that can be used to predict the target variable. The learner must be fitted and have a predict_proba method (for classification) or a predict method (for regression).</span>
<span class="sd">        xs : array-like, optional</span>
<span class="sd">            New calibration input data to append</span>
<span class="sd">        ys : array-like, optional</span>
<span class="sd">            New calibration target data to append</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`.CalibratedExplainer`</span>
<span class="sd">            A :class:`.CalibratedExplainer` object that can be used to explain predictions from a predictive learner.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="n">learner</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learner</span> <span class="o">=</span> <span class="n">learner</span>
        <span class="k">if</span> <span class="n">xs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append_cal</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Cannot mix calibration instances with and without bins.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">DataShapeError</span><span class="p">(</span>
                        <span class="s2">&quot;The length of bins must match the number of added instances.&quot;</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">,</span> <span class="n">bins</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">bins</span>
            <span class="c1"># Phase 1A delegation: update interval learner via helper</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">.calibration_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">update_interval_learner</span> <span class="k">as</span> <span class="n">_upd_il</span>

            <span class="n">_upd_il</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">.calibration_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">initialize_interval_learner</span> <span class="k">as</span> <span class="n">_init_il</span>

            <span class="n">_init_il</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialized</span> <span class="o">=</span> <span class="kc">True</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the string representation of the CalibratedExplainer.&quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=line-too-long</span>
        <span class="n">disp_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;CalibratedExplainer(mode=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="si">}{</span><span class="s1">&#39;, conditional=True&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}{</span><span class="sa">f</span><span class="s1">&#39;, discretizer=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">discretizer</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">discretizer</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">, learner=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">learner</span><span class="si">}{</span><span class="sa">f</span><span class="s1">&#39;, difficulty_estimator=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">difficulty_estimator</span><span class="si">}</span><span class="s1">)&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;regression&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;)&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">disp_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">init_time=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">init_time</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_explanation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">disp_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">total_explain_time=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">latest_explanation</span><span class="o">.</span><span class="n">total_explain_time</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">disp_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">sample_percentiles=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_percentiles</span><span class="si">}</span><span class="se">\</span>
<span class="s2">                        </span><span class="se">\n\t</span><span class="s2">seed=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="si">}</span><span class="se">\</span>
<span class="s2">                        </span><span class="se">\n\t</span><span class="s2">verbose=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">disp_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">feature_names=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">categorical_features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">disp_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">categorical_features=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">categorical_features</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">categorical_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">disp_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">categorical_labels=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">categorical_labels</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">disp_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">class_labels=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">class_labels</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">disp_str</span>

    <span class="c1"># pylint: disable=invalid-name, too-many-return-statements</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># The same meaning as threshold has for cps in crepes.</span>
        <span class="n">low_high_percentiles</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">95</span><span class="p">),</span>
        <span class="n">classes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">feature</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the internal prediction method for classification and regression cases.</span>

<span class="sd">        For classification:</span>
<span class="sd">        - Returns probabilities and intervals for binary/multiclass</span>
<span class="sd">        - Handles Mondrian categories via bins parameter</span>

<span class="sd">        For regression:</span>
<span class="sd">        - Returns predictions and uncertainty intervals</span>
<span class="sd">        - Can return probability predictions when threshold is provided</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : A set of test objects to predict</span>
<span class="sd">        threshold : float, int or array-like of shape (n_samples,), default=None</span>
<span class="sd">            values for which p-values should be returned. Only used for probabilistic explanations for regression.</span>
<span class="sd">        low_high_percentiles : a tuple of floats, default=(5, 95)</span>
<span class="sd">            The low and high percentile used to calculate the interval. Applicable to regression.</span>
<span class="sd">        classes : None or array-like of shape (n_samples,), default=None</span>
<span class="sd">            The classes predicted for the original instance. None if not multiclass or regression.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError: The length of the threshold-parameter must be either a constant or the same as the number of</span>
<span class="sd">            instances in x.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        predict : ndarray of shape (n_samples,)</span>
<span class="sd">            The prediction for the test data. For classification, this is the regularized probability</span>
<span class="sd">            of the positive class, derived using the intervals from VennAbers. For regression, this is the</span>
<span class="sd">            median prediction from the ConformalPredictiveSystem.</span>
<span class="sd">        low : ndarray of shape (n_samples,)</span>
<span class="sd">            The lower bound of the prediction interval. For classification, this is derived using</span>
<span class="sd">            VennAbers. For regression, this is the lower percentile given as parameter, derived from the</span>
<span class="sd">            ConformalPredictiveSystem.</span>
<span class="sd">        high : ndarray of shape (n_samples,)</span>
<span class="sd">            The upper bound of the prediction interval. For classification, this is derived using</span>
<span class="sd">            VennAbers. For regression, this is the upper percentile given as parameter, derived from the</span>
<span class="sd">            ConformalPredictiveSystem.</span>
<span class="sd">        classes : ndarray of shape (n_samples,)</span>
<span class="sd">            The classes predicted for the original instance. None if not multiclass or regression.</span>
<span class="sd">        bins : array-like of shape (n_samples,), default=None</span>
<span class="sd">            Mondrian categories</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># strip plotting-only keys that callers may pass</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;show&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;style_override&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__initialized</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFittedError</span><span class="p">(</span><span class="s2">&quot;The learner must be initialized before calling predict.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">feature</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fast</span><span class="p">():</span>
            <span class="n">feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span>  <span class="c1"># Use the calibrator defined using X_cal</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;classification&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_multiclass</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fast</span><span class="p">():</span>
                    <span class="n">predict</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">new_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">,</span> <span class="n">output_interval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="n">classes</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">predict</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">new_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">,</span> <span class="n">output_interval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="n">classes</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">classes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span>
                        <span class="p">[</span><span class="n">predict</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_classes</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">low</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_classes</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">high</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_classes</span><span class="p">)],</span>
                        <span class="n">new_classes</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">classes</span><span class="p">]</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">predict</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">classes</span><span class="p">)],</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fast</span><span class="p">():</span>
                <span class="n">predict</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">output_interval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">predict</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">output_interval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">predict</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;regression&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
            <span class="c1"># pylint: disable=unexpected-keyword-arg, no-value-for-parameter</span>
            <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># normal regression</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">low_high_percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">low_high_percentiles</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                        <span class="s2">&quot;The low percentile must be smaller than (or equal to) the high percentile.&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                    <span class="p">(</span>
                        <span class="p">(</span><span class="n">low_high_percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">low_high_percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="p">(</span><span class="n">low_high_percentiles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">50</span> <span class="ow">and</span> <span class="n">low_high_percentiles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="ow">or</span> <span class="n">low_high_percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                    <span class="ow">or</span> <span class="n">low_high_percentiles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
                        <span class="n">low_high_percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="ow">and</span> <span class="n">low_high_percentiles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                    <span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                        <span class="s2">&quot;The percentiles must be between 0 and 100 (exclusive). </span><span class="se">\</span>
<span class="s2">                            The lower percentile can be -np.inf and the higher percentile can </span><span class="se">\</span>
<span class="s2">                            be np.inf (but not at the same time) to allow one-sided intervals.&quot;</span>
                    <span class="p">)</span>
                <span class="n">low</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">[</span><span class="n">low_high_percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">50</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">low_high_percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                    <span class="k">else</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">high</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">[</span><span class="n">low_high_percentiles</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">50</span><span class="p">]</span> <span class="k">if</span> <span class="n">low_high_percentiles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="k">else</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fast</span><span class="p">():</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">predict_uncertainty</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span> <span class="n">low_high_percentiles</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span>
                        <span class="p">)</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="o">.</span><span class="n">predict_uncertainty</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">,</span> <span class="n">low_high_percentiles</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># typically crepes broadcasting/shape errors</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suppress_crepes_errors</span><span class="p">:</span>
                        <span class="c1"># Log and return placeholder arrays (caller should handle downstream)</span>
                        <span class="n">_warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="s2">&quot;crepes produced an unexpected result (likely too-small calibration set); returning zeros as a degraded fallback.&quot;</span><span class="p">,</span>
                            <span class="ne">UserWarning</span><span class="p">,</span>
                            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="c1"># produce zero-length or zero arrays consistent with expected shape</span>
                        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="kc">None</span>
                    <span class="c1"># Preserve prior behavior: re-raise the original exception so callers/tests</span>
                    <span class="c1"># see the original error (instead of converting it to DataShapeError).</span>
                    <span class="k">raise</span>

            <span class="c1"># regression with threshold condition</span>
            <span class="n">assert_threshold</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fast</span><span class="p">():</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">predict_probability</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span>
                    <span class="p">)</span>
                <span class="c1"># pylint: disable=unexpected-keyword-arg</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="o">.</span><span class="n">predict_probability</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suppress_crepes_errors</span><span class="p">:</span>
                    <span class="n">_warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s2">&quot;crepes produced an unexpected result while computing probabilities; returning zeros as a degraded fallback.&quot;</span><span class="p">,</span>
                        <span class="ne">UserWarning</span><span class="p">,</span>
                        <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="kc">None</span>
                    <span class="c1"># Re-raise as a clearer DataShapeError with guidance</span>
                    <span class="k">raise</span> <span class="n">DataShapeError</span><span class="p">(</span>
                        <span class="s2">&quot;Error while computing prediction intervals from the underlying crepes library. &quot;</span>
                        <span class="s2">&quot;This commonly occurs when the calibration set is too small for the requested percentiles. &quot;</span>
                        <span class="s2">&quot;Consider using a larger calibration set, or instantiate the explainer with suppress_crepes_errors=True to return a degraded fallback. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;(original error: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>

        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>  <span class="c1"># Should never happen</span>

<div class="viewcode-block" id="CalibratedExplainer.explain_factual">
<a class="viewcode-back" href="../../../_autosummary/calibrated_explanations.core.CalibratedExplainer.html#calibrated_explanations.core.CalibratedExplainer.explain_factual">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">explain_factual</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">low_high_percentiles</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">95</span><span class="p">),</span>
        <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">features_to_ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">_use_plugin</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CalibratedExplanations</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a :class:`.CalibratedExplanations` object for the test data with the discretizer automatically assigned for factual explanations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : array-like</span>
<span class="sd">            A set with n_samples of test objects to predict.</span>
<span class="sd">        threshold : float, int or array-like, default=None</span>
<span class="sd">            Values for which p-values should be returned. Only used for probabilistic explanations for regression.</span>
<span class="sd">        low_high_percentiles : a tuple of floats, default=(5, 95)</span>
<span class="sd">            The low and high percentile used to calculate the interval. Applicable to regression.</span>
<span class="sd">        bins : array-like of shape (n_samples,), default=None</span>
<span class="sd">            Mondrian categories</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError: The number of features in the test data must be the same as in the calibration data.</span>
<span class="sd">        Warning: The threshold-parameter is only supported for mode=&#39;regression&#39;.</span>
<span class="sd">        ValueError: The length of the threshold parameter must be either a constant or the same as the number of</span>
<span class="sd">            instances in x.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        CalibratedExplanations : :class:`.CalibratedExplanations`</span>
<span class="sd">            A `CalibratedExplanations` containing one :class:`.FactualExplanation` for each instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">discretizer</span> <span class="o">=</span> <span class="s2">&quot;binaryRegressor&quot;</span> <span class="k">if</span> <span class="s2">&quot;regression&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="k">else</span> <span class="s2">&quot;binaryEntropy&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_discretizer</span><span class="p">(</span><span class="n">discretizer</span><span class="p">,</span> <span class="n">features_to_ignore</span><span class="o">=</span><span class="n">features_to_ignore</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span>
            <span class="n">threshold</span><span class="p">,</span>
            <span class="n">low_high_percentiles</span><span class="p">,</span>
            <span class="n">bins</span><span class="p">,</span>
            <span class="n">features_to_ignore</span><span class="p">,</span>
            <span class="n">_use_plugin</span><span class="o">=</span><span class="n">_use_plugin</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="CalibratedExplainer.explain_counterfactual">
<a class="viewcode-back" href="../../../_autosummary/calibrated_explanations.core.CalibratedExplainer.html#calibrated_explanations.core.CalibratedExplainer.explain_counterfactual">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">explain_counterfactual</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">low_high_percentiles</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">95</span><span class="p">),</span>
        <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">features_to_ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AlternativeExplanations</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;See documentation for the `explore_alternatives` method.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :meth:`.CalibratedExplainer.explore_alternatives` : Refer to the documentation for `explore_alternatives` for more details.</span>

<span class="sd">        Warnings</span>
<span class="sd">        --------</span>
<span class="sd">        Deprecated: This method is deprecated and may be removed in future versions. Use `explore_alternatives` instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;The `explain_counterfactual` method is deprecated and may be removed in future versions. Use `explore_alternatives` instead.&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">explore_alternatives</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">low_high_percentiles</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">features_to_ignore</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="CalibratedExplainer.explore_alternatives">
<a class="viewcode-back" href="../../../_autosummary/calibrated_explanations.core.CalibratedExplainer.html#calibrated_explanations.core.CalibratedExplainer.explore_alternatives">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">explore_alternatives</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">low_high_percentiles</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">95</span><span class="p">),</span>
        <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">features_to_ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">_use_plugin</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AlternativeExplanations</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a :class:`.AlternativeExplanations` object for the test data with the discretizer automatically assigned for alternative explanations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : array-like</span>
<span class="sd">            A set with n_samples of test objects to predict.</span>
<span class="sd">        threshold : float, int or array-like, default=None</span>
<span class="sd">            Values for which p-values should be returned. Only used for probabilistic explanations for regression.</span>
<span class="sd">        low_high_percentiles : a tuple of floats, default=(5, 95)</span>
<span class="sd">            The low and high percentile used to calculate the interval. Applicable to regression.</span>
<span class="sd">        bins : array-like of shape (n_samples,), default=None</span>
<span class="sd">            Mondrian categories</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError: The number of features in the test data must be the same as in the calibration data.</span>
<span class="sd">        Warning: The threshold-parameter is only supported for mode=&#39;regression&#39;.</span>
<span class="sd">        ValueError: The length of the threshold parameter must be either a constant or the same as the number of</span>
<span class="sd">            instances in x.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        AlternativeExplanations : :class:`.AlternativeExplanations`</span>
<span class="sd">            An `AlternativeExplanations` containing one :class:`.AlternativeExplanation` for each instance.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The `explore_alternatives` will eventually be used instead of the `explain_counterfactual` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">discretizer</span> <span class="o">=</span> <span class="s2">&quot;regressor&quot;</span> <span class="k">if</span> <span class="s2">&quot;regression&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="k">else</span> <span class="s2">&quot;entropy&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_discretizer</span><span class="p">(</span><span class="n">discretizer</span><span class="p">,</span> <span class="n">features_to_ignore</span><span class="o">=</span><span class="n">features_to_ignore</span><span class="p">)</span>
        <span class="c1"># At runtime, explain() will return an AlternativeExplanations when an alternative discretizer is set.</span>
        <span class="c1"># Help mypy with a narrow cast here without changing behavior.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span>
            <span class="n">threshold</span><span class="p">,</span>
            <span class="n">low_high_percentiles</span><span class="p">,</span>
            <span class="n">bins</span><span class="p">,</span>
            <span class="n">features_to_ignore</span><span class="p">,</span>
            <span class="n">_use_plugin</span><span class="o">=</span><span class="n">_use_plugin</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># type: ignore[return-value]</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">low_high_percentiles</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">95</span><span class="p">),</span>
        <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">features_to_ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">_use_plugin</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CalibratedExplanations</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Call self as a function to create a :class:`.CalibratedExplanations` object for the test data with the already assigned discretizer.</span>

<span class="sd">        Since v0.4.0, this method is equivalent to the `explain` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span>
            <span class="n">threshold</span><span class="p">,</span>
            <span class="n">low_high_percentiles</span><span class="p">,</span>
            <span class="n">bins</span><span class="p">,</span>
            <span class="n">features_to_ignore</span><span class="p">,</span>
            <span class="n">_use_plugin</span><span class="o">=</span><span class="n">_use_plugin</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="CalibratedExplainer.explain">
<a class="viewcode-back" href="../../../_autosummary/calibrated_explanations.core.CalibratedExplainer.html#calibrated_explanations.core.CalibratedExplainer.explain">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">explain</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">low_high_percentiles</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">95</span><span class="p">),</span>
        <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">features_to_ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">_use_plugin</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CalibratedExplanations</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate explanations for test instances by analyzing feature effects.</span>

<span class="sd">        This method:</span>
<span class="sd">        1. Makes predictions on original test instances</span>
<span class="sd">        2. Creates perturbed versions by varying feature values</span>
<span class="sd">        3. Analyzes how predictions change with feature perturbations</span>
<span class="sd">        4. Generates feature importance weights and prediction intervals</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        CalibratedExplanations : :class:`.CalibratedExplanations`</span>
<span class="sd">            A :class:`.CalibratedExplanations` containing one :class:`.CalibratedExplanation` for each instance.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :meth:`.CalibratedExplainer.explain_factual` : Refer to the documentation for `explain_factual` for more details.</span>
<span class="sd">        :meth:`.CalibratedExplainer.explore_alternatives` : Refer to the documentation for `explore_alternatives` for more details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">_use_plugin</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infer_explanation_mode</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invoke_explanation_plugin</span><span class="p">(</span>
                <span class="n">mode</span><span class="p">,</span>
                <span class="n">x</span><span class="p">,</span>
                <span class="n">threshold</span><span class="p">,</span>
                <span class="n">low_high_percentiles</span><span class="p">,</span>
                <span class="n">bins</span><span class="p">,</span>
                <span class="n">features_to_ignore</span><span class="p">,</span>
                <span class="n">extras</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="n">mode</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="c1"># Track total explanation time</span>
        <span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

        <span class="n">features_to_ignore</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features_to_ignore</span>
            <span class="k">if</span> <span class="n">features_to_ignore</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features_to_ignore</span><span class="p">,</span> <span class="n">features_to_ignore</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Validate inputs and initialize explanation object</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_and_prepare_input</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">explanation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_explanation</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">low_high_percentiles</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">features_to_ignore</span>
        <span class="p">)</span>

        <span class="n">instance_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

        <span class="c1"># Step 1: Get predictions for original test instances</span>
        <span class="p">(</span>
            <span class="n">predict</span><span class="p">,</span>
            <span class="n">low</span><span class="p">,</span>
            <span class="n">high</span><span class="p">,</span>
            <span class="n">prediction</span><span class="p">,</span>
            <span class="n">perturbed_feature</span><span class="p">,</span>
            <span class="n">rule_boundaries</span><span class="p">,</span>
            <span class="n">lesser_values</span><span class="p">,</span>
            <span class="n">greater_values</span><span class="p">,</span>
            <span class="n">covered_values</span><span class="p">,</span>
            <span class="n">x_cal</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_explain_predict_step</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">low_high_percentiles</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">features_to_ignore</span><span class="p">)</span>

        <span class="c1"># Step 2: Initialize data structures to store feature-level results</span>
        <span class="c1"># Dictionaries to store aggregated results across all instances</span>
        <span class="n">feature_weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;predict&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">feature_predict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;predict&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">binned_predict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># Results for discretized feature values</span>
            <span class="s2">&quot;predict&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;current_bin&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;rule_values&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;counts&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;fractions&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

        <span class="c1"># Initialize per-instance storage</span>
        <span class="n">rule_values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">instance_weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">instance_predict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">instance_binned</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Initialize data structures for each test instance</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">instance</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">rule_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;predict&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="p">}</span>
            <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;predict&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="p">}</span>
            <span class="n">instance_binned</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;predict&quot;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s2">&quot;current_bin&quot;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s2">&quot;rule_values&quot;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s2">&quot;counts&quot;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s2">&quot;fractions&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="p">}</span>

        <span class="c1"># Step 3: Process each feature to analyze its effects</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features_to_ignore</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
                    <span class="n">rule_values</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_values</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="p">])</span>
                    <span class="n">instance_binned</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">predict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">instance_binned</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">low</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">instance_binned</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">high</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">continue</span>

            <span class="c1"># Get discretized values for this feature</span>
            <span class="n">feature_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_values</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
            <span class="n">perturbed</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">perturbed_feature</span> <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">f</span><span class="p">]</span>

            <span class="c1"># Handle categorical and numerical features differently</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">categorical_features</span><span class="p">:</span>
                <span class="c1"># Process categorical feature - analyze effect of each possible value</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">perturbed</span><span class="p">):</span>
                    <span class="n">current_bin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="c1"># Initialize arrays to store predictions for each feature value</span>
                    <span class="n">average_predict</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_values</span><span class="p">))</span>
                    <span class="n">low_predict</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_values</span><span class="p">))</span>
                    <span class="n">high_predict</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_values</span><span class="p">))</span>
                    <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_values</span><span class="p">))</span>

                    <span class="c1"># Calculate predictions for each possible feature value</span>
                    <span class="k">for</span> <span class="n">bin_value</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">feature_values</span><span class="p">):</span>
                        <span class="c1"># Find predictions where this feature was set to this value</span>
                        <span class="n">feature_index</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">perturbed_feature</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">f</span>
                            <span class="ow">and</span> <span class="n">perturbed_feature</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span>
                            <span class="ow">and</span> <span class="n">perturbed_feature</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">perturbed_feature</span><span class="p">))</span>
                        <span class="p">]</span>

                        <span class="c1"># Track original feature value&#39;s bin</span>
                        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
                            <span class="n">current_bin</span> <span class="o">=</span> <span class="n">bin_value</span>

                        <span class="c1"># Store predictions for this value</span>
                        <span class="n">average_predict</span><span class="p">[</span><span class="n">bin_value</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">predict</span><span class="p">[</span><span class="n">feature_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">predict</span><span class="p">[</span><span class="n">feature_index</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="p">)</span>
                        <span class="n">low_predict</span><span class="p">[</span><span class="n">bin_value</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">low</span><span class="p">[</span><span class="n">feature_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">low</span><span class="p">[</span><span class="n">feature_index</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="p">)</span>
                        <span class="n">high_predict</span><span class="p">[</span><span class="n">bin_value</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">high</span><span class="p">[</span><span class="n">feature_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">high</span><span class="p">[</span><span class="n">feature_index</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="p">)</span>
                        <span class="n">counts</span><span class="p">[</span><span class="n">bin_value</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x_cal</span><span class="p">[:,</span> <span class="n">f</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># Store results for this instance</span>
                    <span class="n">rule_values</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">feature_values</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="p">])</span>
                    <span class="n">uncovered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">average_predict</span><span class="p">)),</span> <span class="n">current_bin</span><span class="p">)</span>
                    <span class="n">fractions</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">uncovered</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="n">uncovered</span><span class="p">])</span>

                    <span class="c1"># Store binned predictions</span>
                    <span class="n">instance_binned</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">average_predict</span>
                    <span class="n">instance_binned</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">low_predict</span>
                    <span class="n">instance_binned</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">high_predict</span>
                    <span class="n">instance_binned</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;current_bin&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_bin</span>
                    <span class="n">instance_binned</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;counts&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span>
                    <span class="n">instance_binned</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;fractions&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">fractions</span>

                    <span class="c1"># Handle special case where current bin is the only bin</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uncovered</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

                        <span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Calculate the weighted average (only makes a difference for categorical features)</span>
                        <span class="c1"># instance_predict[&#39;predict&#39;][f] = np.sum(average_predict[uncovered]*fractions[uncovered])</span>
                        <span class="c1"># instance_predict[&#39;low&#39;][f] = np.sum(low_predict[uncovered]*fractions[uncovered])</span>
                        <span class="c1"># instance_predict[&#39;high&#39;][f] = np.sum(high_predict[uncovered]*fractions[uncovered])</span>
                        <span class="c1"># Calculate the average predictions</span>
                        <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">safe_mean</span><span class="p">(</span><span class="n">average_predict</span><span class="p">[</span><span class="n">uncovered</span><span class="p">])</span>
                        <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">safe_mean</span><span class="p">(</span><span class="n">low_predict</span><span class="p">[</span><span class="n">uncovered</span><span class="p">])</span>
                        <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">safe_mean</span><span class="p">(</span><span class="n">high_predict</span><span class="p">[</span><span class="n">uncovered</span><span class="p">])</span>

                        <span class="c1"># Calculate feature importance weights</span>
                        <span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_weight</span><span class="p">(</span>
                            <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">],</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">tmp_low</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_weight</span><span class="p">(</span>
                            <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">],</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">tmp_high</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_weight</span><span class="p">(</span>
                            <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">],</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">tmp_low</span><span class="p">,</span> <span class="n">tmp_high</span><span class="p">])</span>
                        <span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">tmp_low</span><span class="p">,</span> <span class="n">tmp_high</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Get unique feature values and boundaries for this feature</span>
                <span class="n">feature_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_cal</span><span class="p">[:,</span> <span class="n">f</span><span class="p">]))</span>
                <span class="n">lower_boundary</span> <span class="o">=</span> <span class="n">rule_boundaries</span><span class="p">[:,</span> <span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">upper_boundary</span> <span class="o">=</span> <span class="n">rule_boundaries</span><span class="p">[:,</span> <span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

                <span class="c1"># Initialize dictionaries to store predictions and counts for each instance</span>
                <span class="n">avg_predict_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">low_predict_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">high_predict_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">counts_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">rule_value_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
                    <span class="c1"># Set boundary values and initialize arrays based on number of bins</span>
                    <span class="n">lower_boundary</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">lower_boundary</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">feature_values</span> <span class="o">&lt;</span> <span class="n">lower_boundary</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">else</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                    <span class="p">)</span>
                    <span class="n">upper_boundary</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">upper_boundary</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">feature_values</span> <span class="o">&gt;</span> <span class="n">upper_boundary</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                    <span class="p">)</span>
                    <span class="n">num_bins</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">lower_boundary</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">num_bins</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">upper_boundary</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="n">avg_predict_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_bins</span><span class="p">)</span>
                    <span class="n">low_predict_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_bins</span><span class="p">)</span>
                    <span class="n">high_predict_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_bins</span><span class="p">)</span>
                    <span class="n">counts_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_bins</span><span class="p">)</span>
                    <span class="n">rule_value_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># Track bin assignments</span>
                <span class="n">bin_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">current_bin</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

                <span class="c1"># Process instances below lower boundary</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lower_boundary</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">lesser_values</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lower_boundary</span> <span class="o">==</span> <span class="n">val</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="c1"># Find relevant perturbed feature indices</span>
                        <span class="n">index</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">p_i</span>
                            <span class="k">for</span> <span class="n">p_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">perturbed_feature</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">perturbed_feature</span><span class="p">[</span><span class="n">p_i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">f</span>
                            <span class="ow">and</span> <span class="n">perturbed_feature</span><span class="p">[</span><span class="n">p_i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span>
                            <span class="ow">and</span> <span class="n">perturbed_feature</span><span class="p">[</span><span class="n">p_i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">j</span>
                            <span class="ow">and</span> <span class="n">perturbed_feature</span><span class="p">[</span><span class="n">p_i</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
                        <span class="p">]</span>

                        <span class="c1"># Store predictions and counts for values below boundary</span>
                        <span class="n">avg_predict_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bin_value</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">safe_mean</span><span class="p">(</span><span class="n">predict</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="p">)</span>
                        <span class="n">low_predict_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bin_value</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">safe_mean</span><span class="p">(</span><span class="n">low</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="p">)</span>
                        <span class="n">high_predict_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bin_value</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">safe_mean</span><span class="p">(</span><span class="n">high</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="p">)</span>
                        <span class="n">counts_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bin_value</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x_cal</span><span class="p">[:,</span> <span class="n">f</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">val</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">rule_value_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lesser_values</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">bin_value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Process instances above upper boundary</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">upper_boundary</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">greater_values</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">upper_boundary</span> <span class="o">==</span> <span class="n">val</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="c1"># Find relevant perturbed feature indices</span>
                        <span class="n">index</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">p_i</span>
                            <span class="k">for</span> <span class="n">p_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">perturbed_feature</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">perturbed_feature</span><span class="p">[</span><span class="n">p_i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">f</span>
                            <span class="ow">and</span> <span class="n">perturbed_feature</span><span class="p">[</span><span class="n">p_i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span>
                            <span class="ow">and</span> <span class="n">perturbed_feature</span><span class="p">[</span><span class="n">p_i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">j</span>
                            <span class="ow">and</span> <span class="ow">not</span> <span class="n">perturbed_feature</span><span class="p">[</span><span class="n">p_i</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
                        <span class="p">]</span>

                        <span class="c1"># Store predictions and counts for values above boundary</span>
                        <span class="n">avg_predict_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bin_value</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">safe_mean</span><span class="p">(</span><span class="n">predict</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="p">)</span>
                        <span class="n">low_predict_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bin_value</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">safe_mean</span><span class="p">(</span><span class="n">low</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="p">)</span>
                        <span class="n">high_predict_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bin_value</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">safe_mean</span><span class="p">(</span><span class="n">high</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="p">)</span>
                        <span class="n">counts_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bin_value</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x_cal</span><span class="p">[:,</span> <span class="n">f</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">val</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">rule_value_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">greater_values</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">bin_value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Process instances between boundaries</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">_lower</span><span class="p">,</span> <span class="n">_upper</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lower_boundary</span><span class="p">,</span> <span class="n">upper_boundary</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="p">):</span>
                        <span class="c1"># Find relevant perturbed feature indices</span>
                        <span class="n">index</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">p_i</span>
                            <span class="k">for</span> <span class="n">p_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">perturbed_feature</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">perturbed_feature</span><span class="p">[</span><span class="n">p_i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">f</span>
                            <span class="ow">and</span> <span class="n">perturbed_feature</span><span class="p">[</span><span class="n">p_i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span>
                            <span class="ow">and</span> <span class="n">perturbed_feature</span><span class="p">[</span><span class="n">p_i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">j</span>
                            <span class="ow">and</span> <span class="n">perturbed_feature</span><span class="p">[</span><span class="n">p_i</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
                        <span class="p">]</span>

                        <span class="c1"># Store predictions and counts for values between boundaries</span>
                        <span class="n">avg_predict_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bin_value</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">safe_mean</span><span class="p">(</span><span class="n">predict</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="p">)</span>
                        <span class="n">low_predict_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bin_value</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">safe_mean</span><span class="p">(</span><span class="n">low</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="p">)</span>
                        <span class="n">high_predict_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bin_value</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">safe_mean</span><span class="p">(</span><span class="n">high</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="p">)</span>
                        <span class="n">counts_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bin_value</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">x_cal</span><span class="p">[:,</span> <span class="n">f</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">_lower</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x_cal</span><span class="p">[:,</span> <span class="n">f</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">_upper</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">rule_value_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">covered_values</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">current_bin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin_value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="c1"># For each test instance</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
                    <span class="c1"># Store rule values for this feature and instance</span>
                    <span class="n">rule_values</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">rule_value_map</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="p">])</span>

                    <span class="c1"># Get indices of bins not containing current value</span>
                    <span class="n">uncovered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">avg_predict_map</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span> <span class="n">current_bin</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                    <span class="c1"># Calculate fractions for uncovered bins</span>
                    <span class="n">fractions</span> <span class="o">=</span> <span class="n">counts_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">uncovered</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">uncovered</span><span class="p">])</span>

                    <span class="c1"># Store binned prediction results for this feature and instance</span>
                    <span class="n">instance_binned</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">avg_predict_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">instance_binned</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">low_predict_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">instance_binned</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">high_predict_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">instance_binned</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;current_bin&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_bin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">instance_binned</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;counts&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">instance_binned</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;fractions&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">fractions</span>

                    <span class="c1"># Handle the situation where the current bin is the only bin</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uncovered</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

                        <span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Calculate the weighted average (only makes a difference for categorical features)</span>
                        <span class="c1"># instance_predict[&#39;predict&#39;][f] = np.sum(average_predict[uncovered]*fractions[uncovered])</span>
                        <span class="c1"># instance_predict[&#39;low&#39;][f] = np.sum(low_predict[uncovered]*fractions[uncovered])</span>
                        <span class="c1"># instance_predict[&#39;high&#39;][f] = np.sum(high_predict[uncovered]*fractions[uncovered])</span>
                        <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">safe_mean</span><span class="p">(</span><span class="n">avg_predict_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">uncovered</span><span class="p">])</span>
                        <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">safe_mean</span><span class="p">(</span><span class="n">low_predict_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">uncovered</span><span class="p">])</span>
                        <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">safe_mean</span><span class="p">(</span><span class="n">high_predict_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">uncovered</span><span class="p">])</span>

                        <span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_weight</span><span class="p">(</span>
                            <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">],</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">tmp_low</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_weight</span><span class="p">(</span>
                            <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">],</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">tmp_high</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_weight</span><span class="p">(</span>
                            <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">],</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">tmp_low</span><span class="p">,</span> <span class="n">tmp_high</span><span class="p">])</span>
                        <span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">tmp_low</span><span class="p">,</span> <span class="n">tmp_high</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
            <span class="n">binned_predict</span><span class="p">[</span><span class="s2">&quot;predict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_binned</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;predict&quot;</span><span class="p">])</span>
            <span class="n">binned_predict</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_binned</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">])</span>
            <span class="n">binned_predict</span><span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_binned</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">])</span>
            <span class="n">binned_predict</span><span class="p">[</span><span class="s2">&quot;current_bin&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_binned</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;current_bin&quot;</span><span class="p">])</span>
            <span class="n">binned_predict</span><span class="p">[</span><span class="s2">&quot;rule_values&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule_values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">binned_predict</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_binned</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;counts&quot;</span><span class="p">])</span>
            <span class="n">binned_predict</span><span class="p">[</span><span class="s2">&quot;fractions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_binned</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;fractions&quot;</span><span class="p">])</span>

            <span class="n">feature_weights</span><span class="p">[</span><span class="s2">&quot;predict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;predict&quot;</span><span class="p">])</span>
            <span class="n">feature_weights</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">])</span>
            <span class="n">feature_weights</span><span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">])</span>

            <span class="n">feature_predict</span><span class="p">[</span><span class="s2">&quot;predict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;predict&quot;</span><span class="p">])</span>
            <span class="n">feature_predict</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">])</span>
            <span class="n">feature_predict</span><span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">])</span>
        <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">instance_time</span>
        <span class="n">list_instance_time</span> <span class="o">=</span> <span class="p">[</span><span class="n">elapsed_time</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span>

        <span class="n">explanation</span> <span class="o">=</span> <span class="n">explanation</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span>
            <span class="n">binned_predict</span><span class="p">,</span>
            <span class="n">feature_weights</span><span class="p">,</span>
            <span class="n">feature_predict</span><span class="p">,</span>
            <span class="n">prediction</span><span class="p">,</span>
            <span class="n">instance_time</span><span class="o">=</span><span class="n">list_instance_time</span><span class="p">,</span>
            <span class="n">total_time</span><span class="o">=</span><span class="n">total_time</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latest_explanation</span> <span class="o">=</span> <span class="n">explanation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_explanation_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infer_explanation_mode</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">explanation</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_and_prepare_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delegate to extracted helper (Phase 1A).&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.prediction_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">validate_and_prepare_input</span> <span class="k">as</span> <span class="n">_vh</span>

        <span class="k">return</span> <span class="n">_vh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_explanation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">low_high_percentiles</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">features_to_ignore</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delegate to extracted helper (Phase 1A).&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.prediction_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">initialize_explanation</span> <span class="k">as</span> <span class="n">_ih</span>

        <span class="k">return</span> <span class="n">_ih</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">low_high_percentiles</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">features_to_ignore</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_explain_predict_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">low_high_percentiles</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">features_to_ignore</span><span class="p">):</span>
        <span class="c1"># Phase 1A: delegate initial setup to prediction_helpers to lock behavior</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.prediction_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">explain_predict_step</span> <span class="k">as</span> <span class="n">_eps</span>

        <span class="p">(</span>
            <span class="n">_base_predict</span><span class="p">,</span>
            <span class="n">_base_low</span><span class="p">,</span>
            <span class="n">_base_high</span><span class="p">,</span>
            <span class="n">prediction</span><span class="p">,</span>
            <span class="n">perturbed_feature</span><span class="p">,</span>
            <span class="n">rule_boundaries</span><span class="p">,</span>
            <span class="n">lesser_values</span><span class="p">,</span>
            <span class="n">greater_values</span><span class="p">,</span>
            <span class="n">covered_values</span><span class="p">,</span>
            <span class="n">x_cal</span><span class="p">,</span>
            <span class="n">perturbed_threshold</span><span class="p">,</span>
            <span class="n">perturbed_bins</span><span class="p">,</span>
            <span class="n">perturbed_x</span><span class="p">,</span>
            <span class="n">perturbed_class</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">_eps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">low_high_percentiles</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">features_to_ignore</span><span class="p">)</span>

        <span class="c1"># Sub-step 1.b: prepare and add the perturbed test instances (unchanged logic)</span>
        <span class="c1"># pylint: disable=too-many-nested-blocks</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features_to_ignore</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">categorical_features</span><span class="p">:</span>
                <span class="n">feature_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_values</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
                <span class="n">x_copy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">feature_values</span><span class="p">:</span>
                    <span class="n">x_copy</span><span class="p">[:,</span> <span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="n">perturbed_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">perturbed_x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_copy</span><span class="p">)))</span>
                    <span class="n">perturbed_feature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">perturbed_feature</span><span class="p">,</span> <span class="p">[(</span><span class="n">f</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
                    <span class="p">)</span>
                    <span class="n">perturbed_bins</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">perturbed_bins</span><span class="p">,</span> <span class="n">bins</span><span class="p">))</span> <span class="k">if</span> <span class="n">bins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">)</span>
                    <span class="n">perturbed_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">perturbed_class</span><span class="p">,</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;predict&quot;</span><span class="p">]))</span>
                    <span class="n">perturbed_threshold</span> <span class="o">=</span> <span class="n">concatenate_thresholds</span><span class="p">(</span>
                        <span class="n">perturbed_threshold</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_copy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">feature_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_cal</span><span class="p">[:,</span> <span class="n">f</span><span class="p">]))</span>
                <span class="n">lower_boundary</span> <span class="o">=</span> <span class="n">rule_boundaries</span><span class="p">[:,</span> <span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">upper_boundary</span> <span class="o">=</span> <span class="n">rule_boundaries</span><span class="p">[:,</span> <span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
                    <span class="n">lower_boundary</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">lower_boundary</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">feature_values</span> <span class="o">&lt;</span> <span class="n">lower_boundary</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">else</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                    <span class="p">)</span>
                    <span class="n">upper_boundary</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">upper_boundary</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">feature_values</span> <span class="o">&gt;</span> <span class="n">upper_boundary</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                    <span class="p">)</span>

                <span class="n">lesser_values</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">greater_values</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">covered_values</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lower_boundary</span><span class="p">)):</span>
                    <span class="n">lesser_values</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__get_lesser_values</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">val</span><span class="p">)),</span> <span class="n">val</span><span class="p">)</span>
                    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lower_boundary</span> <span class="o">==</span> <span class="n">val</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">lesser_values</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">x_local</span> <span class="o">=</span> <span class="n">x_copy</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="p">:]</span>
                        <span class="n">x_local</span><span class="p">[:,</span> <span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="n">perturbed_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">perturbed_x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_local</span><span class="p">)))</span>
                        <span class="n">perturbed_feature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">perturbed_feature</span><span class="p">,</span> <span class="p">[(</span><span class="n">f</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">])</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">bins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">perturbed_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                                <span class="p">(</span>
                                    <span class="n">perturbed_bins</span><span class="p">,</span>
                                    <span class="n">bins</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">[</span><span class="n">bins</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]],</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="n">perturbed_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">perturbed_class</span><span class="p">,</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;classes&quot;</span><span class="p">][</span><span class="n">indices</span><span class="p">])</span>
                        <span class="p">)</span>
                        <span class="n">perturbed_threshold</span> <span class="o">=</span> <span class="n">concatenate_thresholds</span><span class="p">(</span>
                            <span class="n">perturbed_threshold</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">indices</span>
                        <span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">upper_boundary</span><span class="p">)):</span>
                    <span class="n">greater_values</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__get_greater_values</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">val</span><span class="p">)),</span> <span class="n">val</span><span class="p">)</span>
                    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">upper_boundary</span> <span class="o">==</span> <span class="n">val</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">greater_values</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">x_local</span> <span class="o">=</span> <span class="n">x_copy</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="p">:]</span>
                        <span class="n">x_local</span><span class="p">[:,</span> <span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="n">perturbed_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">perturbed_x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_local</span><span class="p">)))</span>
                        <span class="n">perturbed_feature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">perturbed_feature</span><span class="p">,</span> <span class="p">[(</span><span class="n">f</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">])</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">bins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">perturbed_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                                <span class="p">(</span>
                                    <span class="n">perturbed_bins</span><span class="p">,</span>
                                    <span class="n">bins</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">[</span><span class="n">bins</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]],</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="n">perturbed_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">perturbed_class</span><span class="p">,</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;classes&quot;</span><span class="p">][</span><span class="n">indices</span><span class="p">])</span>
                        <span class="p">)</span>
                        <span class="n">perturbed_threshold</span> <span class="o">=</span> <span class="n">concatenate_thresholds</span><span class="p">(</span>
                            <span class="n">perturbed_threshold</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">indices</span>
                        <span class="p">)</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
                    <span class="n">covered_values</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__get_covered_values</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">lower_boundary</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">upper_boundary</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                        <span class="p">(</span><span class="n">lower_boundary</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">upper_boundary</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">covered_values</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">x_local</span> <span class="o">=</span> <span class="n">x_copy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                        <span class="n">x_local</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="n">perturbed_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">perturbed_x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_local</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
                        <span class="p">)</span>
                        <span class="n">perturbed_feature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">perturbed_feature</span><span class="p">,</span> <span class="p">[(</span><span class="n">f</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]))</span>
                        <span class="n">perturbed_bins</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">perturbed_bins</span><span class="p">,</span> <span class="p">[</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]]))</span>
                            <span class="k">if</span> <span class="n">bins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                            <span class="k">else</span> <span class="kc">None</span>
                        <span class="p">)</span>
                        <span class="n">perturbed_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">perturbed_class</span><span class="p">,</span> <span class="p">[</span><span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;classes&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]])</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">perturbed_threshold</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">perturbed_threshold</span> <span class="o">=</span> <span class="p">[</span><span class="n">threshold</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">perturbed_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                                    <span class="p">(</span><span class="n">perturbed_threshold</span><span class="p">,</span> <span class="p">[</span><span class="n">threshold</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
                                <span class="p">)</span>
        <span class="c1"># Sub-step 1.c: Predict and convert to numpy arrays to allow boolean indexing</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">perturbed_threshold</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">perturbed_threshold</span><span class="p">]</span>
        <span class="n">predict</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span>
            <span class="n">perturbed_x</span><span class="p">,</span>
            <span class="n">threshold</span><span class="o">=</span><span class="n">perturbed_threshold</span><span class="p">,</span>
            <span class="n">low_high_percentiles</span><span class="o">=</span><span class="n">low_high_percentiles</span><span class="p">,</span>
            <span class="n">classes</span><span class="o">=</span><span class="n">perturbed_class</span><span class="p">,</span>
            <span class="n">bins</span><span class="o">=</span><span class="n">perturbed_bins</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">predict</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">predict</span><span class="p">)</span>
        <span class="n">low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
        <span class="n">high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">high</span><span class="p">)</span>
        <span class="c1"># predicted_class = np.array(perturbed_class)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">predict</span><span class="p">,</span>
            <span class="n">low</span><span class="p">,</span>
            <span class="n">high</span><span class="p">,</span>
            <span class="n">prediction</span><span class="p">,</span>
            <span class="n">perturbed_feature</span><span class="p">,</span>
            <span class="n">rule_boundaries</span><span class="p">,</span>
            <span class="n">lesser_values</span><span class="p">,</span>
            <span class="n">greater_values</span><span class="p">,</span>
            <span class="n">covered_values</span><span class="p">,</span>
            <span class="n">x_cal</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="CalibratedExplainer.explain_fast">
<a class="viewcode-back" href="../../../_autosummary/calibrated_explanations.core.CalibratedExplainer.html#calibrated_explanations.core.CalibratedExplainer.explain_fast">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">explain_fast</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">low_high_percentiles</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">95</span><span class="p">),</span>
        <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">_use_plugin</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CalibratedExplanations</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a :class:`.CalibratedExplanations` object for the test data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : array-like</span>
<span class="sd">            A set with n_samples of test objects to predict</span>
<span class="sd">        threshold : float, int or array-like of shape (n_samples,), default=None</span>
<span class="sd">            values for which p-values should be returned. Only used for probabilistic explanations for regression.</span>
<span class="sd">        low_high_percentiles : a tuple of floats, default=(5, 95)</span>
<span class="sd">            The low and high percentile used to calculate the interval. Applicable to regression.</span>
<span class="sd">        bins : array-like of shape (n_samples,), default=None</span>
<span class="sd">            Mondrian categories</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError: The number of features in the test data must be the same as in the calibration data.</span>
<span class="sd">        Warning: The threshold-parameter is only supported for mode=&#39;regression&#39;.</span>
<span class="sd">        ValueError: The length of the threshold parameter must be either a constant or the same as the number of</span>
<span class="sd">            instances in x.</span>
<span class="sd">        RuntimeError: Fast explanations are only possible if the explainer is a Fast Calibrated Explainer.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        CalibratedExplanations : :class:`.CalibratedExplanations`</span>
<span class="sd">            A `CalibratedExplanations` containing one :class:`.FastExplanation` for each instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">_use_plugin</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invoke_explanation_plugin</span><span class="p">(</span>
                <span class="s2">&quot;fast&quot;</span><span class="p">,</span>
                <span class="n">x</span><span class="p">,</span>
                <span class="n">threshold</span><span class="p">,</span>
                <span class="n">low_high_percentiles</span><span class="p">,</span>
                <span class="n">bins</span><span class="p">,</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features_to_ignore</span><span class="p">),</span>
                <span class="n">extras</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;fast&quot;</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fast</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__fast</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_interval_learner_for_fast_explainer</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__fast</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                    <span class="s2">&quot;Fast explanations are only possible if the explainer is a Fast Calibrated Explainer.&quot;</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>
        <span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">instance_time</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">safe_isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;pandas.core.frame.DataFrame&quot;</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DataShapeError</span><span class="p">(</span>
                <span class="s2">&quot;The number of features in the test data must be the same as in the </span><span class="se">\</span>
<span class="s2">                            calibration data.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_mondrian</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">bins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s2">&quot;The bins parameter must be specified for Mondrian explanations.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">DataShapeError</span><span class="p">(</span>
                    <span class="s2">&quot;The length of the bins parameter must be the same as the number of instances in x.&quot;</span>
                <span class="p">)</span>
        <span class="n">explanation</span> <span class="o">=</span> <span class="n">CalibratedExplanations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;regression&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s2">&quot;The threshold parameter is only supported for mode=&#39;regression&#39;.&quot;</span>
                <span class="p">)</span>
            <span class="n">assert_threshold</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="c1"># explanation.low_high_percentiles = low_high_percentiles</span>
        <span class="k">elif</span> <span class="s2">&quot;regression&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
            <span class="n">explanation</span><span class="o">.</span><span class="n">low_high_percentiles</span> <span class="o">=</span> <span class="n">low_high_percentiles</span>

        <span class="n">feature_weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;predict&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
        <span class="n">feature_predict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;predict&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
        <span class="n">instance_weights</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;predict&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">),</span>
                <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">),</span>
                <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="n">instance_predict</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;predict&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">),</span>
                <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">),</span>
                <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="p">]</span>

        <span class="n">feature_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

        <span class="n">predict</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">predicted_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">low_high_percentiles</span><span class="o">=</span><span class="n">low_high_percentiles</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span>
        <span class="p">)</span>
        <span class="n">prediction</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;predict&quot;</span><span class="p">:</span> <span class="n">predict</span><span class="p">,</span>
            <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="n">low</span><span class="p">,</span>
            <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="n">high</span><span class="p">,</span>
            <span class="s2">&quot;classes&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">predicted_class</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_multiclass</span><span class="p">()</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
        <span class="p">}</span>
        <span class="n">y_cal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_cal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_cal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaled_y_cal</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_to_ignore</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">predict</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">predicted_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span>
                <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
                <span class="n">low_high_percentiles</span><span class="o">=</span><span class="n">low_high_percentiles</span><span class="p">,</span>
                <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
                <span class="n">feature</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
                <span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_weight</span><span class="p">(</span>
                    <span class="n">predict</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">tmp_low</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_weight</span><span class="p">(</span><span class="n">low</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                <span class="n">tmp_high</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_weight</span><span class="p">(</span><span class="n">high</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                <span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">tmp_low</span><span class="p">,</span> <span class="n">tmp_high</span><span class="p">])</span>
                <span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">tmp_low</span><span class="p">,</span> <span class="n">tmp_high</span><span class="p">])</span>

                <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">predict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">low</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">high</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_cal</span> <span class="o">=</span> <span class="n">y_cal</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
            <span class="n">feature_weights</span><span class="p">[</span><span class="s2">&quot;predict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;predict&quot;</span><span class="p">])</span>
            <span class="n">feature_weights</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">])</span>
            <span class="n">feature_weights</span><span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">])</span>

            <span class="n">feature_predict</span><span class="p">[</span><span class="s2">&quot;predict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;predict&quot;</span><span class="p">])</span>
            <span class="n">feature_predict</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">])</span>
            <span class="n">feature_predict</span><span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">])</span>
        <span class="n">feature_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">feature_time</span>
        <span class="n">instance_time</span> <span class="o">=</span> <span class="p">[</span><span class="n">feature_time</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">explanation</span><span class="o">.</span><span class="n">finalize_fast</span><span class="p">(</span>
            <span class="n">feature_weights</span><span class="p">,</span>
            <span class="n">feature_predict</span><span class="p">,</span>
            <span class="n">prediction</span><span class="p">,</span>
            <span class="n">instance_time</span><span class="o">=</span><span class="n">instance_time</span><span class="p">,</span>
            <span class="n">total_time</span><span class="o">=</span><span class="n">total_time</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latest_explanation</span> <span class="o">=</span> <span class="n">explanation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_explanation_mode</span> <span class="o">=</span> <span class="s2">&quot;fast&quot;</span>
        <span class="k">return</span> <span class="n">explanation</span></div>


<div class="viewcode-block" id="CalibratedExplainer.explain_lime">
<a class="viewcode-back" href="../../../_autosummary/calibrated_explanations.core.CalibratedExplainer.html#calibrated_explanations.core.CalibratedExplainer.explain_lime">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">explain_lime</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">low_high_percentiles</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">95</span><span class="p">),</span>
        <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CalibratedExplanations</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a :class:`.CalibratedExplanations` object for the test data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : array-like</span>
<span class="sd">            A set with n_samples of test objects to predict</span>
<span class="sd">        threshold : float, int or array-like of shape (n_samples,), default=None</span>
<span class="sd">            values for which p-values should be returned. Only used for probabilistic explanations for regression.</span>
<span class="sd">        low_high_percentiles : a tuple of floats, default=(5, 95)</span>
<span class="sd">            The low and high percentile used to calculate the interval. Applicable to regression.</span>
<span class="sd">        bins : array-like of shape (n_samples,), default=None</span>
<span class="sd">            Mondrian categories</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError: The number of features in the test data must be the same as in the calibration data.</span>
<span class="sd">        Warning: The threshold-parameter is only supported for mode=&#39;regression&#39;.</span>
<span class="sd">        ValueError: The length of the threshold parameter must be either a constant or the same as the number of</span>
<span class="sd">            instances in x.</span>
<span class="sd">        RuntimeError: Fast explanations are only possible if the explainer is a Fast Calibrated Explainer.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        CalibratedExplanations : :class:`.CalibratedExplanations`</span>
<span class="sd">            A `CalibratedExplanations` containing one :class:`.FastExplanation` for each instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lime_enabled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_preload_lime</span><span class="p">()</span>
        <span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">instance_time</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">safe_isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;pandas.core.frame.DataFrame&quot;</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DataShapeError</span><span class="p">(</span>
                <span class="s2">&quot;The number of features in the test data must be the same as in the </span><span class="se">\</span>
<span class="s2">                            calibration data.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_mondrian</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">bins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s2">&quot;The bins parameter must be specified for Mondrian explanations.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">DataShapeError</span><span class="p">(</span>
                    <span class="s2">&quot;The length of the bins parameter must be the same as the number of instances in x.&quot;</span>
                <span class="p">)</span>
        <span class="n">explanation</span> <span class="o">=</span> <span class="n">CalibratedExplanations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;regression&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s2">&quot;The threshold parameter is only supported for mode=&#39;regression&#39;.&quot;</span>
                <span class="p">)</span>
            <span class="n">assert_threshold</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="c1"># explanation.low_high_percentiles = low_high_percentiles</span>
        <span class="k">elif</span> <span class="s2">&quot;regression&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
            <span class="n">explanation</span><span class="o">.</span><span class="n">low_high_percentiles</span> <span class="o">=</span> <span class="n">low_high_percentiles</span>

        <span class="n">feature_weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;predict&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
        <span class="n">feature_predict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;predict&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
        <span class="n">prediction</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;predict&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;classes&quot;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="n">instance_weights</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;predict&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">),</span>
                <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">),</span>
                <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="n">instance_predict</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;predict&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">),</span>
                <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">),</span>
                <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="p">]</span>

        <span class="n">predict</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">predicted_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">low_high_percentiles</span><span class="o">=</span><span class="n">low_high_percentiles</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span>
        <span class="p">)</span>
        <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;predict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predict</span>
        <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">low</span>
        <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">high</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_multiclass</span><span class="p">():</span>
            <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;classes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predicted_class</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;classes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">explainer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lime</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">low_proba</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">low_high_percentiles</span><span class="o">=</span><span class="n">low_high_percentiles</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">low</span><span class="p">])</span>  <span class="c1"># noqa E741</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">high_proba</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">low_high_percentiles</span><span class="o">=</span><span class="n">low_high_percentiles</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">high</span><span class="p">])</span>  <span class="c1"># noqa E741</span>

        <span class="n">res_struct</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">res_struct</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">res_struct</span><span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">res_struct</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="s2">&quot;explanation&quot;</span><span class="p">],</span> <span class="n">res_struct</span><span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="s2">&quot;explanation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">res_struct</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="s2">&quot;abs_rank&quot;</span><span class="p">],</span> <span class="n">res_struct</span><span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="s2">&quot;abs_rank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">res_struct</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="s2">&quot;values&quot;</span><span class="p">],</span> <span class="n">res_struct</span><span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="s2">&quot;values&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">instance</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">instance_timer</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

            <span class="k">assert</span> <span class="n">explainer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">low</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">explain_instance</span><span class="p">(</span>
                <span class="n">instance</span><span class="p">,</span> <span class="n">predict_fn</span><span class="o">=</span><span class="n">low_proba</span><span class="p">,</span> <span class="n">num_features</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">high</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">explain_instance</span><span class="p">(</span>
                <span class="n">instance</span><span class="p">,</span> <span class="n">predict_fn</span><span class="o">=</span><span class="n">high_proba</span><span class="p">,</span> <span class="n">num_features</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">res_struct</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="s2">&quot;explanation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
            <span class="n">res_struct</span><span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="s2">&quot;explanation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">high</span><span class="p">)</span>
            <span class="n">res_struct</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="s2">&quot;abs_rank&quot;</span><span class="p">],</span> <span class="n">res_struct</span><span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="s2">&quot;abs_rank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instance</span><span class="p">)),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instance</span><span class="p">)),</span>
            <span class="p">)</span>
            <span class="n">res_struct</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="s2">&quot;values&quot;</span><span class="p">],</span> <span class="n">res_struct</span><span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="s2">&quot;values&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instance</span><span class="p">)),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instance</span><span class="p">)),</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">low</span><span class="o">.</span><span class="n">local_exp</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">res_struct</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="s2">&quot;abs_rank&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">low</span><span class="o">.</span><span class="n">local_exp</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">res_struct</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="s2">&quot;values&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">high</span><span class="o">.</span><span class="n">local_exp</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">res_struct</span><span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="s2">&quot;abs_rank&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">high</span><span class="o">.</span><span class="n">local_exp</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">res_struct</span><span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="s2">&quot;values&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">):</span>
                <span class="n">tmp_low</span> <span class="o">=</span> <span class="n">res_struct</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="s2">&quot;values&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span>
                <span class="n">tmp_high</span> <span class="o">=</span> <span class="n">res_struct</span><span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="s2">&quot;values&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span>
                <span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">tmp_low</span><span class="p">,</span> <span class="n">tmp_high</span><span class="p">])</span>
                <span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">tmp_low</span><span class="p">,</span> <span class="n">tmp_high</span><span class="p">])</span>
                <span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="mi">1</span> <span class="o">-</span> <span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">+</span> <span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">low</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">high</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;predict&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="mi">1</span> <span class="o">-</span> <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">+</span> <span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="n">feature_weights</span><span class="p">[</span><span class="s2">&quot;predict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;predict&quot;</span><span class="p">])</span>
            <span class="n">feature_weights</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">])</span>
            <span class="n">feature_weights</span><span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">])</span>

            <span class="n">feature_predict</span><span class="p">[</span><span class="s2">&quot;predict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;predict&quot;</span><span class="p">])</span>
            <span class="n">feature_predict</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">])</span>
            <span class="n">feature_predict</span><span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_predict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">])</span>
            <span class="n">instance_time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">instance_timer</span><span class="p">)</span>

        <span class="n">explanation</span><span class="o">.</span><span class="n">finalize_fast</span><span class="p">(</span>
            <span class="n">feature_weights</span><span class="p">,</span>
            <span class="n">feature_predict</span><span class="p">,</span>
            <span class="n">prediction</span><span class="p">,</span>
            <span class="n">instance_time</span><span class="o">=</span><span class="n">instance_time</span><span class="p">,</span>
            <span class="n">total_time</span><span class="o">=</span><span class="n">total_time</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latest_explanation</span> <span class="o">=</span> <span class="n">explanation</span>
        <span class="k">return</span> <span class="n">explanation</span></div>


<div class="viewcode-block" id="CalibratedExplainer.assign_threshold">
<a class="viewcode-back" href="../../../_autosummary/calibrated_explanations.core.CalibratedExplainer.html#calibrated_explanations.core.CalibratedExplainer.assign_threshold">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assign_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assign the threshold for the explainer.</span>

<span class="sd">        The threshold is used to calculate the p-values for the predictions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">tuple</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,))</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">threshold</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_assign_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance_predict</span><span class="p">,</span> <span class="n">prediction</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">prediction</span> <span class="o">-</span> <span class="n">instance_predict</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">[</span><span class="n">prediction</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ip</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">instance_predict</span><span class="p">)]</span>
        <span class="p">)</span>  <span class="c1"># probabilistic regression</span>

<div class="viewcode-block" id="CalibratedExplainer.is_multiclass">
<a class="viewcode-back" href="../../../_autosummary/calibrated_explanations.core.CalibratedExplainer.html#calibrated_explanations.core.CalibratedExplainer.is_multiclass">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_multiclass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test if it is a multiclass problem.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if multiclass.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">&gt;</span> <span class="mi">2</span></div>


<div class="viewcode-block" id="CalibratedExplainer.is_fast">
<a class="viewcode-back" href="../../../_autosummary/calibrated_explanations.core.CalibratedExplainer.html#calibrated_explanations.core.CalibratedExplainer.is_fast">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_fast</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test if the explainer is fast.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if fast.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fast</span></div>


<div class="viewcode-block" id="CalibratedExplainer.rule_boundaries">
<a class="viewcode-back" href="../../../_autosummary/calibrated_explanations.core.CalibratedExplainer.html#calibrated_explanations.core.CalibratedExplainer.rule_boundaries">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">rule_boundaries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instances</span><span class="p">,</span> <span class="n">perturbed_instances</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract the rule boundaries for a set of instances.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        instances : array-like</span>
<span class="sd">            The instances to extract boundaries for.</span>
<span class="sd">        perturbed_instances : array-like, optional</span>
<span class="sd">            Discretized versions of instances. Defaults to None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        array-like</span>
<span class="sd">            Min and max values for each feature for each instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># backwards compatibility</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">min_max</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">perturbed_instances</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">perturbed_instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_discretize</span><span class="p">(</span><span class="n">instances</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">discretizer</span><span class="o">.</span><span class="n">to_discretize</span><span class="p">:</span>
                    <span class="n">min_max</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">instances</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="n">instances</span><span class="p">[</span><span class="n">f</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">discretizer</span><span class="o">.</span><span class="n">mins</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="mi">1</span><span class="p">:],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]))</span>
                    <span class="n">min_max</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">discretizer</span><span class="o">.</span><span class="n">mins</span><span class="p">[</span><span class="n">f</span><span class="p">][</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">perturbed_instances</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">f</span><span class="p">],</span> <span class="n">bins</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">discretizer</span><span class="o">.</span><span class="n">maxs</span><span class="p">[</span><span class="n">f</span><span class="p">][</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">perturbed_instances</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">f</span><span class="p">],</span> <span class="n">bins</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="p">],</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
            <span class="k">return</span> <span class="n">min_max</span>
        <span class="n">instances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span>  <span class="c1"># Ensure instances is a numpy array</span>
        <span class="k">if</span> <span class="n">perturbed_instances</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">perturbed_instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_discretize</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">perturbed_instances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">perturbed_instances</span>
            <span class="p">)</span>  <span class="c1"># Ensure perturbed_instances is a numpy array</span>

        <span class="n">all_min_max</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">instance</span><span class="p">,</span> <span class="n">perturbed_instance</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">instances</span><span class="p">,</span> <span class="n">perturbed_instances</span><span class="p">):</span>
            <span class="n">min_max</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">discretizer</span><span class="o">.</span><span class="n">to_discretize</span><span class="p">:</span>
                    <span class="n">min_max</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">instance</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="n">instance</span><span class="p">[</span><span class="n">f</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">discretizer</span><span class="o">.</span><span class="n">mins</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="mi">1</span><span class="p">:],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]))</span>
                    <span class="n">min_max</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">discretizer</span><span class="o">.</span><span class="n">mins</span><span class="p">[</span><span class="n">f</span><span class="p">][</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">perturbed_instance</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="n">bins</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">discretizer</span><span class="o">.</span><span class="n">maxs</span><span class="p">[</span><span class="n">f</span><span class="p">][</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">perturbed_instance</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="n">bins</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="p">],</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
            <span class="n">all_min_max</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">min_max</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_min_max</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">__get_greater_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">greater</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get sampled values above ``greater`` for numerical features.</span>

<span class="sd">        Uses percentile sampling from calibration data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">[:,</span> <span class="n">f</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">greater</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">[:,</span> <span class="n">f</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">greater</span><span class="p">,</span> <span class="n">f</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_percentiles</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__get_lesser_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">lesser</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get sampled values below ``lesser`` for numerical features.</span>

<span class="sd">        Uses percentile sampling from calibration data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">[:,</span> <span class="n">f</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lesser</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">[:,</span> <span class="n">f</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lesser</span><span class="p">,</span> <span class="n">f</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_percentiles</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__get_covered_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">lesser</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">greater</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get sampled values within the ``[lesser, greater]`` interval.</span>

<span class="sd">        Uses percentile sampling from calibration data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">covered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">[:,</span> <span class="n">f</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">lesser</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">[:,</span> <span class="n">f</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">greater</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">[</span><span class="n">covered</span><span class="p">,</span> <span class="n">f</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_percentiles</span><span class="p">)</span>

<div class="viewcode-block" id="CalibratedExplainer.set_seed">
<a class="viewcode-back" href="../../../_autosummary/calibrated_explanations.core.CalibratedExplainer.html#calibrated_explanations.core.CalibratedExplainer.set_seed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_seed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Change the seed used in the random number generator.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        seed : int</span>
<span class="sd">            The seed to be used in the random number generator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span></div>


<div class="viewcode-block" id="CalibratedExplainer.set_difficulty_estimator">
<a class="viewcode-back" href="../../../_autosummary/calibrated_explanations.core.CalibratedExplainer.html#calibrated_explanations.core.CalibratedExplainer.set_difficulty_estimator">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_difficulty_estimator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">difficulty_estimator</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assign or update the difficulty estimator.</span>

<span class="sd">        If initialized to a difficulty estimator, the explainer can be used to reject explanations that are deemed too difficult.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        difficulty_estimator : :class:`crepes.extras.DifficultyEstimator` or None):</span>
<span class="sd">            A :class:`crepes.extras.DifficultyEstimator` object from the crepes package. To remove the :class:`crepes.extras.DifficultyEstimator`, set to None.</span>
<span class="sd">        initialize (bool, optional):</span>
<span class="sd">            If true, then the interval learner is initialized once done. Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">difficulty_estimator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">difficulty_estimator</span><span class="o">.</span><span class="n">fitted</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">NotFittedError</span><span class="p">(</span>
                        <span class="s2">&quot;The difficulty estimator is not fitted. Please fit the estimator first.&quot;</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NotFittedError</span><span class="p">(</span>
                    <span class="s2">&quot;The difficulty estimator is not fitted. Please fit the estimator first.&quot;</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">difficulty_estimator</span> <span class="o">=</span> <span class="n">difficulty_estimator</span>
        <span class="k">if</span> <span class="n">initialize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_interval_learner</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">__constant_sigma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">learner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>  <span class="c1"># pylint: disable=unused-argument</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_sigma_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the difficulty (sigma) of the test instances.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">difficulty_estimator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__constant_sigma</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">difficulty_estimator</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__set_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assign the mode of the explainer. The mode can be either &#39;classification&#39; or &#39;regression&#39;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            mode (str): The mode can be either &#39;classification&#39; or &#39;regression&#39;.</span>
<span class="sd">            initialize (bool, optional): If true, then the interval learner is initialized once done. Defaults to True.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">            ValueError: The mode can be either &#39;classification&#39; or &#39;regression&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;classification&quot;</span><span class="p">:</span>
            <span class="c1"># assert &#39;predict_proba&#39; in dir(self.learner), &quot;The learner must have a predict_proba method.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_cal</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;regression&quot;</span><span class="p">:</span>
            <span class="c1"># assert &#39;predict&#39; in dir(self.learner), &quot;The learner must have a predict method.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;The mode must be either &#39;classification&#39; or &#39;regression&#39;.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="k">if</span> <span class="n">initialize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_interval_learner</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__update_interval_learner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pylint: disable=unused-argument</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fast</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;Fast explanations are not supported in this update path.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;classification&quot;</span><span class="p">:</span>
            <span class="c1"># pylint: disable=fixme</span>
            <span class="c1"># TODO: change so that existing calibrators are extended with new calibration instances</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span> <span class="o">=</span> <span class="n">VennAbers</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">y_cal</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">learner</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">,</span>
                <span class="n">difficulty_estimator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difficulty_estimator</span><span class="p">,</span>
                <span class="n">predict_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_function</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;regression&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;Fast explanations are not supported in this update path.&quot;</span><span class="p">)</span>
            <span class="c1"># update the IntervalRegressor</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="o">.</span><span class="n">insert_calibration</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialized</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__initialize_interval_learner</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Thin delegator kept for backward-compatibility internal calls</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.calibration_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">initialize_interval_learner</span> <span class="k">as</span> <span class="n">_init_il</span>

        <span class="n">_init_il</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="c1"># pylint: disable=attribute-defined-outside-init</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">__initialize_interval_learner_for_fast_explainer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.calibration_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
            <span class="n">initialize_interval_learner_for_fast_explainer</span> <span class="k">as</span> <span class="n">_init_fast</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">_init_fast</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="CalibratedExplainer.initialize_reject_learner">
<a class="viewcode-back" href="../../../_autosummary/calibrated_explanations.core.CalibratedExplainer.html#calibrated_explanations.core.CalibratedExplainer.initialize_reject_learner">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_reject_learner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calibration_set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the reject learner with a threshold value.</span>

<span class="sd">        The reject learner is a :class:`crepes.base.ConformalClassifier`</span>
<span class="sd">        that is trained on the calibration data. The reject learner is used to determine whether a test</span>
<span class="sd">        instance is within the calibration data distribution. The reject learner is only available for</span>
<span class="sd">        classification, unless a threshold is assigned.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        calibration_set : array-like, optional</span>
<span class="sd">            The calibration set to use. Defaults to None.</span>
<span class="sd">        threshold : float, optional</span>
<span class="sd">            The threshold value. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">calibration_set</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_cal</span><span class="p">,</span> <span class="n">y_cal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_cal</span>
        <span class="k">elif</span> <span class="n">calibration_set</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="n">x_cal</span><span class="p">,</span> <span class="n">y_cal</span> <span class="o">=</span> <span class="n">calibration_set</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_cal</span><span class="p">,</span> <span class="n">y_cal</span> <span class="o">=</span> <span class="n">calibration_set</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">calibration_set</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reject_threshold</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="s2">&quot;regression&quot;</span><span class="p">:</span>
            <span class="n">proba_1</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="o">.</span><span class="n">predict_probability</span><span class="p">(</span>
                <span class="n">x_cal</span><span class="p">,</span> <span class="n">y_threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bins</span>
            <span class="p">)</span>
            <span class="n">proba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">proba_1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">proba_1</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proba_1</span><span class="p">))])</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_cal</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reject_threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_multiclass</span><span class="p">():</span>  <span class="c1"># pylint: disable=protected-access</span>
            <span class="n">proba</span><span class="p">,</span> <span class="n">classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">x_cal</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">)</span>
            <span class="n">proba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">proba</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">proba</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">classes</span><span class="p">)])</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">classes</span> <span class="o">==</span> <span class="n">y_cal</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">x_cal</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">)</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="n">y_cal</span>
        <span class="n">alphas_cal</span> <span class="o">=</span> <span class="n">hinge</span><span class="p">(</span><span class="n">proba</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">classes</span><span class="p">),</span> <span class="n">classes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reject_learner</span> <span class="o">=</span> <span class="n">ConformalClassifier</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">alphas</span><span class="o">=</span><span class="n">alphas_cal</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">classes</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reject_learner</span></div>


<div class="viewcode-block" id="CalibratedExplainer.predict_reject">
<a class="viewcode-back" href="../../../_autosummary/calibrated_explanations.core.CalibratedExplainer.html#calibrated_explanations.core.CalibratedExplainer.predict_reject">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict_reject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict whether to reject the explanations for the test data.</span>

<span class="sd">        Use conformal classifier to identify test instances that may be too different from calibration data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : array-like</span>
<span class="sd">            The test data.</span>
<span class="sd">        bins : array-like, optional</span>
<span class="sd">            Mondrian categories. Defaults to None.</span>
<span class="sd">        confidence : float, default=0.95</span>
<span class="sd">            The confidence level.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        array-like</span>
<span class="sd">            Returns rejection decisions and error/rejection rates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="s2">&quot;regression&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reject_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s2">&quot;The reject learner is only available for regression with a threshold.&quot;</span>
                <span class="p">)</span>
            <span class="n">proba_1</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="o">.</span><span class="n">predict_probability</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reject_threshold</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span>
            <span class="p">)</span>
            <span class="n">proba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">proba_1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">proba_1</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proba_1</span><span class="p">))])</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_multiclass</span><span class="p">():</span>  <span class="c1"># pylint: disable=protected-access</span>
            <span class="n">proba</span><span class="p">,</span> <span class="n">classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
            <span class="n">proba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">proba</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">proba</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">classes</span><span class="p">)])</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_cal</span><span class="p">)</span>
        <span class="n">alphas_test</span> <span class="o">=</span> <span class="n">hinge</span><span class="p">(</span><span class="n">proba</span><span class="p">)</span>

        <span class="n">prediction_set</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reject_learner</span><span class="o">.</span><span class="n">predict_set</span><span class="p">(</span>
                    <span class="n">alphas_test</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alphas_test</span><span class="p">),</span> <span class="n">classes</span><span class="p">[</span><span class="n">c</span><span class="p">]),</span> <span class="n">confidence</span><span class="o">=</span><span class="n">confidence</span>
                <span class="p">)[:,</span> <span class="n">c</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">))</span>
            <span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">singleton</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">prediction_set</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">empty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">prediction_set</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">epsilon</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span>
        <span class="n">error_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">epsilon</span> <span class="o">-</span> <span class="n">empty</span><span class="p">)</span> <span class="o">/</span> <span class="n">singleton</span>
        <span class="n">reject_rate</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">singleton</span> <span class="o">/</span> <span class="n">n</span>

        <span class="n">rejected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">prediction_set</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">rejected</span><span class="p">,</span> <span class="n">error_rate</span><span class="p">,</span> <span class="n">reject_rate</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">constant_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">[:,</span> <span class="n">f</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">f</span><span class="p">])</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_to_ignore</span> <span class="o">=</span> <span class="n">constant_columns</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_discretize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply the discretizer to the data sample x.</span>

<span class="sd">        For new data samples and missing values, the nearest bin is used.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : array-like</span>
<span class="sd">            The data sample to discretize.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        array-like</span>
<span class="sd">            The discretized data sample.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># Ensure x is a numpy array</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">discretizer</span><span class="o">.</span><span class="n">to_discretize</span><span class="p">:</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">discretizer</span><span class="o">.</span><span class="n">mins</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="mi">1</span><span class="p">:],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]))</span>
            <span class="n">x</span><span class="p">[:,</span> <span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">discretizer</span><span class="o">.</span><span class="n">means</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="p">],</span> <span class="n">bins</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="p">]</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="c1"># pylint: disable=too-many-branches</span>
<div class="viewcode-block" id="CalibratedExplainer.set_discretizer">
<a class="viewcode-back" href="../../../_autosummary/calibrated_explanations.core.CalibratedExplainer.html#calibrated_explanations.core.CalibratedExplainer.set_discretizer">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_discretizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">discretizer</span><span class="p">,</span> <span class="n">x_cal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y_cal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">features_to_ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assign the discretizer to be used.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        discretizer : str or discretizer object</span>
<span class="sd">            The discretizer to be used.</span>
<span class="sd">        X_cal : array-like, optional</span>
<span class="sd">            The calibration data for the discretizer.</span>
<span class="sd">        y_cal : array-like, optional</span>
<span class="sd">            The calibration target data for the discretizer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">x_cal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_cal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span>
        <span class="k">if</span> <span class="n">y_cal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y_cal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_cal</span>

        <span class="k">if</span> <span class="n">discretizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">discretizer</span> <span class="o">=</span> <span class="s2">&quot;binaryRegressor&quot;</span> <span class="k">if</span> <span class="s2">&quot;regression&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="k">else</span> <span class="s2">&quot;binaryEntropy&quot;</span>
        <span class="k">elif</span> <span class="s2">&quot;regression&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="n">discretizer</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">or</span> <span class="n">discretizer</span>
                <span class="ow">in</span> <span class="p">{</span>
                    <span class="s2">&quot;regressor&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;binaryRegressor&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s2">&quot;The discretizer must be &#39;binaryRegressor&#39; (default for factuals) or &#39;regressor&#39; (default for alternatives) for regression.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="n">discretizer</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">or</span> <span class="n">discretizer</span>
                <span class="ow">in</span> <span class="p">{</span>
                    <span class="s2">&quot;entropy&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;binaryEntropy&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s2">&quot;The discretizer must be &#39;binaryEntropy&#39; (default for factuals) or &#39;entropy&#39; (default for alternatives) for classification.&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">features_to_ignore</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">features_to_ignore</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">not_to_discretize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">categorical_features</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_to_ignore</span><span class="p">),</span> <span class="n">features_to_ignore</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">discretizer</span> <span class="o">==</span> <span class="s2">&quot;binaryEntropy&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">discretizer</span><span class="p">,</span> <span class="n">BinaryEntropyDiscretizer</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discretizer</span> <span class="o">=</span> <span class="n">BinaryEntropyDiscretizer</span><span class="p">(</span>
                <span class="n">x_cal</span><span class="p">,</span> <span class="n">not_to_discretize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">y_cal</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">discretizer</span> <span class="o">==</span> <span class="s2">&quot;binaryRegressor&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">discretizer</span><span class="p">,</span> <span class="n">BinaryRegressorDiscretizer</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discretizer</span> <span class="o">=</span> <span class="n">BinaryRegressorDiscretizer</span><span class="p">(</span>
                <span class="n">x_cal</span><span class="p">,</span> <span class="n">not_to_discretize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">y_cal</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">discretizer</span> <span class="o">==</span> <span class="s2">&quot;entropy&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">discretizer</span><span class="p">,</span> <span class="n">EntropyDiscretizer</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discretizer</span> <span class="o">=</span> <span class="n">EntropyDiscretizer</span><span class="p">(</span>
                <span class="n">x_cal</span><span class="p">,</span> <span class="n">not_to_discretize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">y_cal</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">discretizer</span> <span class="o">==</span> <span class="s2">&quot;regressor&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">discretizer</span><span class="p">,</span> <span class="n">RegressorDiscretizer</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discretizer</span> <span class="o">=</span> <span class="n">RegressorDiscretizer</span><span class="p">(</span>
                <span class="n">x_cal</span><span class="p">,</span> <span class="n">not_to_discretize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">y_cal</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discretized_X_cal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_discretize</span><span class="p">(</span><span class="n">immutable_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">feature_values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_frequencies</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">):</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">discretized_X_cal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discretized_X_cal</span><span class="p">[:,</span> <span class="n">feature</span><span class="p">]</span>
            <span class="n">feature_count</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">column</span><span class="p">:</span>
                <span class="n">feature_count</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_count</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">values</span><span class="p">,</span> <span class="n">frequencies</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">feature_count</span><span class="o">.</span><span class="n">items</span><span class="p">()))))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">feature_values</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_frequencies</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">frequencies</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">frequencies</span><span class="p">))</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_is_mondrian</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return whether the explainer is a Mondrian explainer.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            bool: True if Mondrian</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="c1"># pylint: disable=too-many-return-statements</span>
<div class="viewcode-block" id="CalibratedExplainer.predict">
<a class="viewcode-back" href="../../../_autosummary/calibrated_explanations.core.CalibratedExplainer.html#calibrated_explanations.core.CalibratedExplainer.predict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">uq_interval</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">calibrated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate predictions for the test data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : array-like</span>
<span class="sd">            The test data.</span>
<span class="sd">        uq_interval : bool, default=False</span>
<span class="sd">            Whether to return uncertainty intervals.</span>
<span class="sd">        calibrated : bool, default=True</span>
<span class="sd">            If True, the calibrator is used for prediction. If False, the underlying learner is used for prediction.</span>
<span class="sd">        **kwargs : Various types, optional</span>
<span class="sd">            Additional parameters to customize the explanation process. Supported parameters include:</span>

<span class="sd">            - threshold : float, int, or array-like of shape (n_samples,), optional, default=None</span>
<span class="sd">                Specifies the threshold(s) to get a thresholded prediction for regression tasks (prediction labels such as ``y_hat &lt;= threshold`` or ``y_hat &gt; threshold``). This parameter is ignored for classification tasks.</span>

<span class="sd">            - low_high_percentiles : tuple of two floats, optional, default=(5, 95)</span>
<span class="sd">                The lower and upper percentiles used to calculate the prediction interval for regression tasks. Determines the breadth of the interval based on the distribution of the predictions. This parameter is ignored for classification tasks.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If the learner has not been fitted prior to making predictions.</span>

<span class="sd">        Warning</span>
<span class="sd">            If the learner is not calibrated.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        calibrated_prediction : float or array-like, or str</span>
<span class="sd">            The calibrated prediction. For regression tasks, this is the median of the conformal predictive system or a thresholded prediction if ``threshold`` is set. For classification tasks, it is the class label with the highest calibrated probability.</span>
<span class="sd">        interval : tuple of floats, optional</span>
<span class="sd">            A tuple (low, high) representing the lower and upper bounds of the uncertainty interval. This is returned only if ``uq_interval=True``.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        For a prediction without prediction intervals:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            w.predict(x)</span>

<span class="sd">        For a prediction with uncertainty quantification intervals:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            w.predict(x, uq_interval=True)</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The `threshold` and `low_high_percentiles` parameters are only used for regression tasks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Phase 1B: emit deprecation warnings for aliases and normalize kwargs</span>
        <span class="n">warn_on_aliases</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">canonicalize_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">validate_param_combination</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">calibrated</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;threshold&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s2">&quot;A thresholded prediction is not possible for uncalibrated predictions.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">uq_interval</span><span class="p">:</span>
                <span class="n">predict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learner</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">predict</span><span class="p">,</span> <span class="p">(</span><span class="n">predict</span><span class="p">,</span> <span class="n">predict</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">learner</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="s2">&quot;regression&quot;</span><span class="p">:</span>
            <span class="n">predict</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;threshold&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">get_label</span><span class="p">(</span><span class="n">predict</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">threshold</span><span class="p">):</span>
                        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;y_hat &lt;= </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">predict</span> <span class="o">&gt;=</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;y_hat &gt; </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                        <span class="k">return</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> &lt; y_hat &lt;= </span><span class="si">{</span><span class="n">threshold</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="k">if</span> <span class="n">predict</span> <span class="o">&gt;=</span> <span class="mf">0.5</span>
                            <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;y_hat &lt;= </span><span class="si">{</span><span class="n">threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> || y_hat &gt; </span><span class="si">{</span><span class="n">threshold</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">return</span> <span class="p">(</span>
                        <span class="s2">&quot;Error in CalibratedExplainer.predict.get_label()&quot;</span>  <span class="c1"># should not reach here</span>
                    <span class="p">)</span>

                <span class="n">threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="n">new_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_label</span><span class="p">(</span><span class="n">predict</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">threshold</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">predict</span><span class="p">))]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_label</span><span class="p">(</span><span class="n">predict</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">threshold</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">predict</span><span class="p">))]</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">new_classes</span><span class="p">,</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">))</span> <span class="k">if</span> <span class="n">uq_interval</span> <span class="k">else</span> <span class="n">new_classes</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">predict</span><span class="p">,</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">))</span> <span class="k">if</span> <span class="n">uq_interval</span> <span class="k">else</span> <span class="n">predict</span>

        <span class="n">predict</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">new_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_classes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">predict</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">class_labels</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">new_classes</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">new_classes</span><span class="p">,</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">))</span> <span class="k">if</span> <span class="n">uq_interval</span> <span class="k">else</span> <span class="n">new_classes</span></div>


<div class="viewcode-block" id="CalibratedExplainer.predict_proba">
<a class="viewcode-back" href="../../../_autosummary/calibrated_explanations.core.CalibratedExplainer.html#calibrated_explanations.core.CalibratedExplainer.predict_proba">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">uq_interval</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">calibrated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate probability predictions for the test data.</span>

<span class="sd">        This is a wrapper around the predict_proba method which is more similar to the scikit-learn predict_proba method for classification.</span>
<span class="sd">        As opposed to predict_proba, this method may output uncertainty intervals.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : array-like</span>
<span class="sd">            The test data for which predictions are to be made. This should be in a format compatible with sklearn (e.g., numpy arrays, pandas DataFrames).</span>
<span class="sd">        uq_interval : bool, default=False</span>
<span class="sd">            If true, then the prediction interval is returned as well.</span>
<span class="sd">        calibrated : bool, default=True</span>
<span class="sd">            If True, the calibrator is used for prediction. If False, the underlying learner is used for prediction.</span>
<span class="sd">        threshold : float, int or array-like of shape (n_samples,), optional, default=None</span>
<span class="sd">            Threshold values used with regression to get probability of being below the threshold. Only applicable to regression.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If the learner is not fitted before predicting.</span>

<span class="sd">        ValueError</span>
<span class="sd">            If the `threshold` parameter&#39;s length does not match the number of instances in `x`, or if it is not a single constant value applicable to all instances.</span>

<span class="sd">        RuntimeError</span>
<span class="sd">            If the learner is not fitted before predicting.</span>

<span class="sd">        Warning</span>
<span class="sd">            If the learner is not calibrated.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        calibrated probability :</span>
<span class="sd">            The calibrated probability of the positive class (or the predicted class for multiclass).</span>
<span class="sd">        (low, high) : tuple of float lists, corresponding to the lower and upper bound of each prediction interval.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        For a prediction without uncertainty quantification intervals:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            w.predict_proba(x)</span>

<span class="sd">        For a prediction with uncertainty quantification intervals:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            w.predict_proba(x, uq_interval=True)</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The `threshold` parameter is only used for regression tasks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># strip plotting-only keys that callers may pass</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;show&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;style_override&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Phase 1B: emit deprecation warnings for aliases and normalize kwargs</span>
        <span class="n">warn_on_aliases</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">canonicalize_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">validate_param_combination</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">calibrated</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s2">&quot;A thresholded prediction is not possible for uncalibrated learners.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">uq_interval</span><span class="p">:</span>
                <span class="n">proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learner</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">proba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">proba</span><span class="p">,</span> <span class="p">(</span><span class="n">proba</span><span class="p">,</span> <span class="n">proba</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">proba</span><span class="p">,</span> <span class="p">(</span><span class="n">proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">learner</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="s2">&quot;regression&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">proba_1</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">predict_probability</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y_threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">proba_1</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="o">.</span><span class="n">predict_probability</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y_threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span>
            <span class="n">proba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">proba_1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">proba_1</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proba_1</span><span class="p">))])</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">proba</span><span class="p">,</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">))</span> <span class="k">if</span> <span class="n">uq_interval</span> <span class="k">else</span> <span class="n">proba</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_multiclass</span><span class="p">():</span>  <span class="c1"># pylint: disable=protected-access</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">proba</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">output_interval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">proba</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">output_interval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">proba</span><span class="p">,</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">))</span> <span class="k">if</span> <span class="n">uq_interval</span> <span class="k">else</span> <span class="n">proba</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">proba</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">output_interval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">proba</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_learner</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">output_interval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">proba</span><span class="p">,</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">))</span> <span class="k">if</span> <span class="n">uq_interval</span> <span class="k">else</span> <span class="n">proba</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_is_lime_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_enabled</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return whether lime export is enabled.</span>

<span class="sd">        If is_enabled is not None, then the lime export is enabled/disabled according to the value of is_enabled.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            is_enabled (bool, optional): is used to assign whether lime export is enabled or not. Defaults to None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            bool: returns whether lime export is enabled</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_enabled</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__lime_enabled</span> <span class="o">=</span> <span class="n">is_enabled</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lime_enabled</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_shap_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_enabled</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return whether shap export is enabled.</span>

<span class="sd">        If is_enabled is not None, then the shap export is enabled/disabled according to the value of is_enabled.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            is_enabled (bool, optional): is used to assign whether shap export is enabled or not. Defaults to None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            bool: returns whether shap export is enabled</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_enabled</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__shap_enabled</span> <span class="o">=</span> <span class="n">is_enabled</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__shap_enabled</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_preload_lime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_cal</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">lime</span> <span class="o">:=</span> <span class="n">safe_import</span><span class="p">(</span><span class="s2">&quot;lime.lime_tabular&quot;</span><span class="p">,</span> <span class="s2">&quot;LimeTabularExplainer&quot;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_lime_enabled</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;classification&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lime</span> <span class="o">=</span> <span class="n">lime</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="k">if</span> <span class="n">x_cal</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x_cal</span><span class="p">,</span>
                    <span class="n">feature_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">,</span>
                    <span class="n">class_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">],</span>
                    <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lime_exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lime</span><span class="o">.</span><span class="n">explain_instance</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">learner</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">,</span> <span class="n">num_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;regression&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lime</span> <span class="o">=</span> <span class="n">lime</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="k">if</span> <span class="n">x_cal</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x_cal</span><span class="p">,</span>
                    <span class="n">feature_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;regression&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lime_exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lime</span><span class="o">.</span><span class="n">explain_instance</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">learner</span><span class="o">.</span><span class="n">predict</span><span class="p">,</span> <span class="n">num_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_lime_enabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lime</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lime_exp</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_preload_shap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_test</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">shap</span> <span class="o">:=</span> <span class="n">safe_import</span><span class="p">(</span><span class="s2">&quot;shap&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_shap_enabled</span><span class="p">()</span>
                <span class="ow">or</span> <span class="n">num_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">shap_exp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">num_test</span>
            <span class="p">):</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">shap</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">Explainer</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shap_exp</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">shap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">num_test</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">shap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">[:</span><span class="n">num_test</span><span class="p">,</span> <span class="p">:])</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_is_shap_enabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shap_exp</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># pylint: disable=duplicate-code, too-many-branches, too-many-statements, too-many-locals</span>
<div class="viewcode-block" id="CalibratedExplainer.plot">
<a class="viewcode-back" href="../../../_autosummary/calibrated_explanations.core.CalibratedExplainer.html#calibrated_explanations.core.CalibratedExplainer.plot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate plots for the test data.&quot;&quot;&quot;</span>
        <span class="c1"># Pass any style overrides along to the plotting function</span>
        <span class="n">style_override</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;style_override&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;style_override&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">style_override</span>
        <span class="n">_plot_global</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="CalibratedExplainer.calibrated_confusion_matrix">
<a class="viewcode-back" href="../../../_autosummary/calibrated_explanations.core.CalibratedExplainer.html#calibrated_explanations.core.CalibratedExplainer.calibrated_confusion_matrix">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calibrated_confusion_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a calibrated confusion matrix.</span>

<span class="sd">        Generates a confusion matrix for the calibration set to provide insights about model behavior.</span>
<span class="sd">        The confusion matrix is only available for classification tasks. Leave-one-out cross-validation is</span>
<span class="sd">        used on the calibration set to generate the confusion matrix.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        array-like</span>
<span class="sd">            The calibrated confusion matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;classification&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="s2">&quot;The confusion matrix is only available for classification tasks.&quot;</span>
            <span class="p">)</span>
        <span class="n">cal_predicted_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_cal</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_cal</span><span class="p">)):</span>
            <span class="n">va</span> <span class="o">=</span> <span class="n">VennAbers</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">[:</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">y_cal</span><span class="p">[:</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_cal</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:])),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">learner</span><span class="p">,</span>
                <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">[:</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">predict</span> <span class="o">=</span> <span class="n">va</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
                <span class="n">output_interval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">cal_predicted_classes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">predict</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_cal</span><span class="p">,</span> <span class="n">cal_predicted_classes</span><span class="p">)</span></div>


<div class="viewcode-block" id="CalibratedExplainer.predict_calibration">
<a class="viewcode-back" href="../../../_autosummary/calibrated_explanations.core.CalibratedExplainer.html#calibrated_explanations.core.CalibratedExplainer.predict_calibration">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict_calibration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict the target values for the calibration data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        array-like</span>
<span class="sd">            Predicted values for the calibration data. For models that expose a hat matrix,</span>
<span class="sd">            this returns updated predictions using that matrix; otherwise it uses the</span>
<span class="sd">            predict_function on the calibration data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_cal</span><span class="p">)</span></div>
</div>



<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CalibratedExplainer&quot;</span><span class="p">]</span>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023, Helena Löfström, Tuwe Löfström
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            <div class="last-updated">
              Last updated on Oct 25, 2025</div>
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/Moffran/calibrated_explanations" aria-label="GitHub"><svg stroke='currentColor' fill='currentColor' stroke-width='0' viewBox='0 0 16 16' height='1.4em' width='1.4em' xmlns='http://www.w3.org/2000/svg'><path fill-rule='evenodd' d='M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z'></path></svg></a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../../_static/documentation_options.js?v=486e5634"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/scripts/furo.js?v=46bd48cc"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs"></script>
    <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
    <script type="module">
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";
window.addEventListener("load", () => mermaid.run());
</script>
    </body>
</html>